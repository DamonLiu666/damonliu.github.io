<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>4.ElasticSearch常用的增删查改操作 | Learning Paradise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ElasticSearch常用的增删查改操作使用Java对ElasticSearch增删查改操作，分为两个步骤：1.拼接sql语句2.执行增删查改操作以下提供了一些常用的轮子。 sql拼接1.最普通的sql拼接123456789101112&#x2F;** * Get query DSL * @param queryString * @return Query DSL *&#x2F;public String get">
<meta property="og:type" content="article">
<meta property="og:title" content="4.ElasticSearch常用的增删查改操作">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2019&#x2F;12&#x2F;30&#x2F;4.ElasticSearch%E5%B8%B8%E7%94%A8%E7%9A%84%E5%A2%9E%E5%88%A0%E6%9F%A5%E6%94%B9%E6%93%8D%E4%BD%9C&#x2F;index.html">
<meta property="og:site_name" content="Learning Paradise">
<meta property="og:description" content="ElasticSearch常用的增删查改操作使用Java对ElasticSearch增删查改操作，分为两个步骤：1.拼接sql语句2.执行增删查改操作以下提供了一些常用的轮子。 sql拼接1.最普通的sql拼接123456789101112&#x2F;** * Get query DSL * @param queryString * @return Query DSL *&#x2F;public String get">
<meta property="article:published_time" content="2019-12-30T12:28:10.070Z">
<meta property="article:modified_time" content="2019-12-30T12:27:29.569Z">
<meta property="article:author" content="Damon Liu">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Learning Paradise" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Learning Paradise</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-4.ElasticSearch常用的增删查改操作" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/30/4.ElasticSearch%E5%B8%B8%E7%94%A8%E7%9A%84%E5%A2%9E%E5%88%A0%E6%9F%A5%E6%94%B9%E6%93%8D%E4%BD%9C/" class="article-date">
  <time datetime="2019-12-30T12:28:10.070Z" itemprop="datePublished">2019-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      4.ElasticSearch常用的增删查改操作
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ElasticSearch常用的增删查改操作"><a href="#ElasticSearch常用的增删查改操作" class="headerlink" title="ElasticSearch常用的增删查改操作"></a>ElasticSearch常用的增删查改操作</h1><p>使用Java对ElasticSearch增删查改操作，分为两个步骤：<br>1.拼接sql语句<br>2.执行增删查改操作<br>以下提供了一些常用的轮子。</p>
<h2 id="sql拼接"><a href="#sql拼接" class="headerlink" title="sql拼接"></a>sql拼接</h2><h3 id="1-最普通的sql拼接"><a href="#1-最普通的sql拼接" class="headerlink" title="1.最普通的sql拼接"></a>1.最普通的sql拼接</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get query DSL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queryString</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Query DSL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getQueryDSL</span><span class="params">(String queryString)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	String dsl = <span class="string">"&#123;"</span> + <span class="string">" \"query\": &#123; "</span> + <span class="string">" \"query_string\": &#123; "</span> + <span class="string">" \"query\":\""</span> + queryString + <span class="string">"\" "</span> + <span class="string">"&#125;"</span> + <span class="string">" &#125; "</span></span><br><span class="line">			+ <span class="string">" &#125; "</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dsl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-查询并根据字段排序"><a href="#2-查询并根据字段排序" class="headerlink" title="2.查询并根据字段排序"></a>2.查询并根据字段排序</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get query DSL with sort</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sortByASCOrDesc : key:sort field, value: asc or desc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> query DSL with sort</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getQueryDSL</span><span class="params">(String queryString, Map&lt;String, String&gt; sortByASCOrDesc)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	String dsl = <span class="string">"&#123;"</span> + <span class="string">" \"query\": &#123; "</span> + <span class="string">" \"query_string\": &#123; "</span> + <span class="string">" \"query\":\""</span> + queryString + <span class="string">"\" "</span> + <span class="string">"&#125;"</span> + <span class="string">" &#125; "</span>;</span><br><span class="line"></span><br><span class="line">	StringBuilder builder = <span class="keyword">new</span> StringBuilder(dsl);</span><br><span class="line"></span><br><span class="line">	builder.append(<span class="string">", \"sort\": ["</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; pars : sortByASCOrDesc.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">			builder.append(String.format(<span class="string">"&#123;\"%s\":\"%s\"&#125;"</span>, pars.getKey(), pars.getValue()));</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			builder.append(String.format(<span class="string">",&#123;\"%s\":\"%s\"&#125;"</span>, pars.getKey(), pars.getValue()));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		index++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	builder.append(<span class="string">"]"</span>);</span><br><span class="line">	 </span><br><span class="line">	builder.append(<span class="string">" &#125; "</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> builder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-查询区间并排序"><a href="#3-查询区间并排序" class="headerlink" title="3.查询区间并排序"></a>3.查询区间并排序</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get query DSL with range</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;queryString&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;rangeMap: Key = range field, value = key = gte or gt or lte or lt, value = value &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; sortByASCOrDesc: key:sort field, value: asc or desc. input null if no need sort &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> query DSL with range</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getRangeQueryDSL</span><span class="params">(String queryString, Map&lt;String, Map&lt;String, String&gt;&gt; rangeMap, Map&lt;String, String&gt; sortByASCOrDesc)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	StringBuilder strBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">	strBuilder.append(<span class="string">"&#123;"</span>).append(<span class="string">"\"query\": &#123;"</span>)</span><br><span class="line">	.append(<span class="string">"\"bool\": &#123;"</span>).append(<span class="string">"\"must\": ["</span>).append(<span class="string">"&#123;"</span>)</span><br><span class="line">			.append(<span class="string">"\"query_string\": &#123;"</span>).append(<span class="string">" \"query\":\""</span> + queryString + <span class="string">"\" "</span>).append(<span class="string">"&#125;"</span>).append(<span class="string">"&#125;,"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> jj = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (Map.Entry&lt;String, Map&lt;String, String&gt;&gt; pair : rangeMap.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">		String field = pair.getKey();</span><br><span class="line"></span><br><span class="line">		Map&lt;String, String&gt; range = pair.getValue();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (jj == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">			strBuilder.append(<span class="string">"&#123;"</span>).append(<span class="string">"\"range\": &#123;"</span>).append(<span class="string">" \""</span> + field + <span class="string">"\": &#123; "</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">int</span> ii = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; map : range.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (ii == <span class="number">0</span> &amp;&amp; range.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">					strBuilder.append(<span class="string">" \""</span> + map.getKey() + <span class="string">"\": \""</span> + map.getValue() + <span class="string">"\" , "</span>);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					strBuilder.append(<span class="string">" \""</span> + map.getKey() + <span class="string">"\": \""</span> + map.getValue() + <span class="string">"\"  "</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				ii++;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">			strBuilder.append(<span class="string">"&#125;"</span>).append(<span class="string">"&#125;"</span>).append(<span class="string">"&#125;"</span>);</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">			strBuilder.append(<span class="string">",&#123;"</span>).append(<span class="string">"\"range\": &#123;"</span>).append(<span class="string">" \""</span> + field + <span class="string">"\": &#123; "</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">int</span> ii = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; map : range.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (ii == <span class="number">0</span> &amp;&amp; range.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">					strBuilder.append(<span class="string">" \""</span> + map.getKey() + <span class="string">"\": \""</span> + map.getValue() + <span class="string">"\" , "</span>);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					strBuilder.append(<span class="string">" \""</span> + map.getKey() + <span class="string">"\": \""</span> + map.getValue() + <span class="string">"\"  "</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				ii++;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">			strBuilder.append(<span class="string">"&#125;"</span>).append(<span class="string">"&#125;"</span>).append(<span class="string">"&#125;"</span>);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		jj++;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	strBuilder.append(<span class="string">"]"</span>).append(<span class="string">"&#125;"</span>).append(<span class="string">"&#125;"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(sortByASCOrDesc !=<span class="keyword">null</span>)&#123;</span><br><span class="line">		</span><br><span class="line">		strBuilder.append(<span class="string">", \"sort\": ["</span>);</span><br><span class="line"></span><br><span class="line">		jj = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; pars : sortByASCOrDesc.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (jj == <span class="number">0</span>) &#123;</span><br><span class="line">				strBuilder.append(String.format(<span class="string">"&#123;\"%s\":\"%s\"&#125;"</span>, pars.getKey(), pars.getValue()));</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				strBuilder.append(String.format(<span class="string">",&#123;\"%s\":\"%s\"&#125;"</span>, pars.getKey(), pars.getValue()));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			jj++;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		 strBuilder.append(<span class="string">"]"</span>);</span><br><span class="line">		 </span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">	strBuilder.append(<span class="string">"&#125;"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> strBuilder.toString();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-查所有"><a href="#4-查所有" class="headerlink" title="4.查所有"></a>4.查所有</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getQueryAllDSL</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	String dsl = <span class="string">"&#123; "</span> + <span class="string">" \"query\": &#123; "</span> + <span class="string">" \"match_all\": &#123;&#125; "</span> + <span class="string">" &#125; "</span> + <span class="string">" &#125; "</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dsl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-根据字段分组"><a href="#5-根据字段分组" class="headerlink" title="5.根据字段分组"></a>5.根据字段分组</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getAggsQueryDsl</span><span class="params">(String queryString, String strAggs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">    <span class="string">"&#123;"</span> + </span><br><span class="line">      <span class="string">"\"query\": &#123;"</span> + </span><br><span class="line">         <span class="string">"\"bool\": &#123;"</span> + </span><br><span class="line">            <span class="string">"\"must\": ["</span> + </span><br><span class="line">               <span class="string">"&#123;"</span> + </span><br><span class="line">                  <span class="string">"\"query_string\": &#123;"</span> + </span><br><span class="line">                     <span class="string">"\"default_field\": \"_all\","</span> + </span><br><span class="line">                     <span class="string">"\"query\": \""</span> + queryString + <span class="string">"\""</span> + </span><br><span class="line">                   <span class="string">"&#125;"</span> + </span><br><span class="line">               <span class="string">"&#125;"</span> + </span><br><span class="line">            <span class="string">"]"</span> + </span><br><span class="line">          <span class="string">"&#125;"</span> + </span><br><span class="line">        <span class="string">"&#125;,"</span> +</span><br><span class="line">        <span class="string">"\"size\": 0,"</span> +</span><br><span class="line">        <span class="string">"\"aggs\": &#123;"</span> + strAggs +<span class="string">"&#125;"</span>+ </span><br><span class="line">    <span class="string">"&#125;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：<br>1).使用aggs聚合函数可以根据字段去重分组，如果有多字段需要去重分组，可以嵌套使用aggs；<br>2).实际项目中，建议尽量少的使用aggs，会比较吃性能，建议将数据查询后，在后台代码中进行去重分组</p>
<h2 id="查询-Query"><a href="#查询-Query" class="headerlink" title="查询(Query)"></a>查询(Query)</h2><h3 id="1-执行查询操作，返回结果用实体类封装"><a href="#1-执行查询操作，返回结果用实体类封装" class="headerlink" title="1.执行查询操作，返回结果用实体类封装"></a>1.执行查询操作，返回结果用实体类封装</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get Documents by query DSL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dsl variable sample: &#123; "query":&#123; "query_string":&#123; "query":"field:value" &#125; &#125; &#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classOfT sample: xxxVO.class</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> List&lt;xxxVO&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getDocListByQueryDSL</span><span class="params">(String index, String type, String dsl, Class&lt;T&gt; classOfT)</span> </span>&#123;</span><br><span class="line">	String scrollId = <span class="string">""</span>;</span><br><span class="line">	List&lt;T&gt; list;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		list = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">		SearchResponse scrollResp = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type).setExtraSource(dsl).setFrom(<span class="number">0</span>)</span><br><span class="line">				.setSize(<span class="number">2000</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute().actionGet();</span><br><span class="line">		scrollId = scrollResp.getScrollId();</span><br><span class="line">		Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (SearchHit searchHit : scrollResp.getHits().getHits()) &#123;</span><br><span class="line">				list.add(gson.fromJson(searchHit.getSourceAsString(), classOfT));</span><br><span class="line">			&#125;</span><br><span class="line">			scrollResp = <span class="keyword">this</span>.esClient.prepareSearchScroll(scrollId).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute()</span><br><span class="line">					.actionGet();</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">while</span> (scrollResp.getHits().getHits().length &gt; <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-执行查询操作，返回结果用map封装"><a href="#2-执行查询操作，返回结果用map封装" class="headerlink" title="2.执行查询操作，返回结果用map封装"></a>2.执行查询操作，返回结果用map封装</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get document map by query DSL </span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dsl sample: &#123; "query":&#123; "query_string":&#123; "query":"field:value" &#125; &#125; &#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classOfT</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Map&lt;String, T&gt; Key = document ID , value = Document VO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Map&lt;String, T&gt; <span class="title">getDocMapByQueryDSL</span><span class="params">(String index, String type, String dsl, Class&lt;T&gt; classOfT)</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	String scrollId = <span class="string">""</span>;</span><br><span class="line">	</span><br><span class="line">	Map&lt;String, T&gt; retMap;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		</span><br><span class="line">		retMap = <span class="keyword">new</span> HashMap&lt;String, T&gt;();</span><br><span class="line"></span><br><span class="line">		SearchResponse scrollResp = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type).setExtraSource(dsl).setFrom(<span class="number">0</span>)</span><br><span class="line">				.setSize(<span class="number">2000</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute().actionGet();</span><br><span class="line">		scrollId = scrollResp.getScrollId();</span><br><span class="line">		</span><br><span class="line">		Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">for</span> (SearchHit searchHit : scrollResp.getHits().getHits()) &#123;</span><br><span class="line">				retMap.put(searchHit.getId(), gson.fromJson(searchHit.getSourceAsString(), classOfT));</span><br><span class="line">			&#125;</span><br><span class="line">			scrollResp = <span class="keyword">this</span>.esClient.prepareSearchScroll(scrollId).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute()</span><br><span class="line">					.actionGet();</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">while</span> (scrollResp.getHits().getHits().length &gt; <span class="number">0</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> retMap;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-根据ID查询"><a href="#3-根据ID查询" class="headerlink" title="3.根据ID查询"></a>3.根据ID查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get one document by document ID</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> docID sample: AAA_BBB_CCC</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classOfT </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> xxxVO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getDocByDocID</span><span class="params">(String index, String type, String docID, Class&lt;T&gt; classOfT)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	GetResponse response = <span class="keyword">this</span>.esClient.prepareGet(index, type, docID).get();</span><br><span class="line"></span><br><span class="line">	Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> gson.fromJson(response.getSourceAsString(), classOfT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-根据ID的List查询"><a href="#4-根据ID的List查询" class="headerlink" title="4.根据ID的List查询"></a>4.根据ID的List查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get documents by their ID</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> docIDs sample:List&lt;AAA_BBB_CCC  &gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classOfT</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getDocListByDocID</span><span class="params">(String index, String type, List&lt;String&gt; docIDs, Class&lt;T&gt; classOfT)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	String scrollId = <span class="string">""</span>;</span><br><span class="line">	List&lt;T&gt; list;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">		list = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">		SearchResponse scrollResp = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type)</span><br><span class="line">				.setQuery(QueryBuilders.idsQuery().ids(docIDs)).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).setFrom(<span class="number">0</span>)</span><br><span class="line">				.setSize(<span class="number">1000</span>).execute().actionGet();</span><br><span class="line"></span><br><span class="line">		Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (SearchHit searchHit : scrollResp.getHits().getHits()) &#123;</span><br><span class="line">				list.add(gson.fromJson(searchHit.getSourceAsString(), classOfT));</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			scrollId = scrollResp.getScrollId();</span><br><span class="line">			</span><br><span class="line">			scrollResp = <span class="keyword">this</span>.esClient.prepareSearchScroll(scrollId).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute()</span><br><span class="line">					.actionGet();</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">while</span> (scrollResp.getHits().getHits().length &gt; <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-根据ID查询字段值，返回结果用map封装"><a href="#5-根据ID查询字段值，返回结果用map封装" class="headerlink" title="5.根据ID查询字段值，返回结果用map封装"></a>5.根据ID查询字段值，返回结果用map封装</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get extra source of documents by document IDs</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fields</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &lt;p&gt;Map&lt;String, Object&gt; key = id_field, value = document id_field's value.</span></span><br><span class="line"><span class="comment"> *            sample:Map&lt;AAA_BBB_CCC_field, value&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getExtraMapByDocID</span><span class="params">(String index, String type, List&lt;String&gt; ids, String... fields)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	SearchResponse response = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type)</span><br><span class="line">			.setQuery(QueryBuilders.idsQuery().ids(ids)).setFetchSource(fields, <span class="keyword">null</span>)</span><br><span class="line">			.setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).setFrom(<span class="number">0</span>).setSize(<span class="number">1000</span>).execute().actionGet();</span><br><span class="line"></span><br><span class="line">	Map&lt;String, Object&gt; retMap = Maps.newHashMap();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (String field : fields) &#123;</span><br><span class="line"></span><br><span class="line">				String key = String.format(<span class="string">"%s_%s"</span>, hit.getId(), field);</span><br><span class="line"></span><br><span class="line">				retMap.put(key, hit.getSource().get(field));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		response = <span class="keyword">this</span>.esClient.prepareSearchScroll(response.getScrollId()).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>))</span><br><span class="line">				.execute().actionGet();</span><br><span class="line">		<span class="comment">// Break condition: No hits are returned</span></span><br><span class="line">		<span class="keyword">if</span> (response.getHits().getHits().length == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> retMap;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-根据sql查询字段值"><a href="#6-根据sql查询字段值" class="headerlink" title="6.根据sql查询字段值"></a>6.根据sql查询字段值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get Extra _source</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queryString</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fields</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> List&lt;Map&lt;String, Object&gt;&gt; Map&lt;String, Object&gt; each document key &amp;</span></span><br><span class="line"><span class="comment"> *         value List&lt;Map&lt;String, Object&gt;&gt; all document key &amp; value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; getExtraMapByQueryDSL(String index, String type, String queryDSL, String... fields)</span><br><span class="line">		<span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">	List&lt;Map&lt;String, Object&gt;&gt; rtnLst = Lists.newArrayList();</span><br><span class="line"></span><br><span class="line">	String scrollId = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">		SearchResponse response = <span class="keyword">this</span>.esClient.prepareSearch(index)</span><br><span class="line">				.setTypes(type).setExtraSource(queryDSL)</span><br><span class="line">				.setFetchSource(fields, <span class="keyword">null</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).setFrom(<span class="number">0</span>).setSize(<span class="number">1000</span>).execute()</span><br><span class="line">				.actionGet();</span><br><span class="line"></span><br><span class="line">		scrollId = response.getScrollId();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.getHitsResult(response, rtnLst, fields);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rtnLst</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fields</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Map&lt;String, Object&gt;&gt; getHitsResult(SearchResponse response, List&lt;Map&lt;String, Object&gt;&gt; rtnLst,</span><br><span class="line">		String... fields) &#123; </span><br><span class="line">	<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line">			Map&lt;String, Object&gt; tempMap = Maps.newHashMap();</span><br><span class="line">			<span class="keyword">for</span> (String field : fields) &#123;</span><br><span class="line">				tempMap.put(field, hit.getSource().get(field));</span><br><span class="line">			&#125;</span><br><span class="line">			rtnLst.add(tempMap);</span><br><span class="line">		&#125;</span><br><span class="line">		response = <span class="keyword">this</span>.esClient.prepareSearchScroll(response.getScrollId()).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>))</span><br><span class="line">				.execute().actionGet();</span><br><span class="line">		<span class="keyword">if</span> (response.getHits().getHits().length == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rtnLst;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-查询排序后的第一笔数据"><a href="#7-查询排序后的第一笔数据" class="headerlink" title="7.查询排序后的第一笔数据"></a>7.查询排序后的第一笔数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get Top 1 document by sorted DSL</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dsl</span></span><br><span class="line"><span class="comment"> *            should by with sort</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classOfT</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getTop1DocByQueryDSL</span><span class="params">(String index, String type, String dsl, Class&lt;T&gt; classOfT)</span> </span>&#123;</span><br><span class="line">	String scrollId = <span class="string">""</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		SearchResponse scrollResp = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type).setExtraSource(dsl).setFrom(<span class="number">0</span>)</span><br><span class="line">				.setSize(<span class="number">1</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute().actionGet();</span><br><span class="line">		scrollId = scrollResp.getScrollId();</span><br><span class="line">		Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">		<span class="keyword">for</span> (SearchHit searchHit : scrollResp.getHits().getHits()) &#123;</span><br><span class="line">			<span class="keyword">return</span> gson.fromJson(searchHit.getSourceAsString(), classOfT);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-通过sql查询数据是否存在"><a href="#8-通过sql查询数据是否存在" class="headerlink" title="8.通过sql查询数据是否存在"></a>8.通过sql查询数据是否存在</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check document exist or not by query DSL</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queryDsl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> esIndex</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> esType</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkDocExistByQueryDSL</span><span class="params">(String esIndex, String esType, String queryDsl)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">		SearchRequestBuilder searchBuilder = <span class="keyword">this</span>.esClient.prepareSearch(esIndex).setTypes(esType)</span><br><span class="line">				.setFetchSource(<span class="keyword">new</span> String[] &#123; <span class="string">"_id"</span> &#125;, <span class="keyword">null</span>).setExtraSource(queryDsl).setFrom(<span class="number">0</span>).setSize(<span class="number">1</span>)</span><br><span class="line">				.setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>));</span><br><span class="line"></span><br><span class="line">		SearchResponse scrollResp = searchBuilder.execute().actionGet();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (scrollResp.getHits().getTotalHits() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> e;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-查询数据笔数"><a href="#9-查询数据笔数" class="headerlink" title="9.查询数据笔数"></a>9.查询数据笔数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return total count by DSL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">getTotalHitsByDsl</span><span class="params">(String index, String type, String dsl)</span> </span>&#123;</span><br><span class="line">    String scrollId = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SearchResponse scrollResp = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type).setExtraSource(dsl).setFrom(<span class="number">0</span>)</span><br><span class="line">                .setSize(<span class="number">0</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute().actionGet();</span><br><span class="line">        scrollId = scrollResp.getScrollId();</span><br><span class="line">        <span class="keyword">return</span> scrollResp.getHits().getTotalHits();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="新增-Upsert"><a href="#新增-Upsert" class="headerlink" title="新增(Upsert)"></a>新增(Upsert)</h2><p>注：upsert用法：有记录就更新，没有记录就新增</p>
<h3 id="1-通过ID-执行upsert操作"><a href="#1-通过ID-执行upsert操作" class="headerlink" title="1.通过ID 执行upsert操作"></a>1.通过ID 执行upsert操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Upsert data by VO + document ID.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> vo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">IndexResponse <span class="title">upsert</span><span class="params">(String index, String type, String docID, T vo)</span> </span>&#123;</span><br><span class="line">	Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">	String source = gson.toJson(vo);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.esClient.prepareIndex(index, type, docID).setRefresh(<span class="keyword">true</span>).setSource(source).execute().actionGet();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-批量upsert"><a href="#2-批量upsert" class="headerlink" title="2.批量upsert"></a>2.批量upsert</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> voList</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> getDocIDMethodInVo</span></span><br><span class="line"><span class="comment">   *                sample : public String getDocumentID() &#123; return</span></span><br><span class="line"><span class="comment">   *               String.format("%s_%s", AAA,BBB); &#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> isAutoRefresh</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">bulkProcessUpsert</span><span class="params">(String index, String type, List&lt;T&gt; voList, String getDocIDMethodInVo, <span class="keyword">boolean</span> isAutoRefresh)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">      </span><br><span class="line">      BulkRequestBuilder bulkRequest = <span class="keyword">this</span>.esClient.prepareBulk();</span><br><span class="line">      bulkRequest.setTimeout(TimeValue.timeValueMinutes(<span class="number">20</span>));</span><br><span class="line">      </span><br><span class="line">  	<span class="keyword">for</span> (T vo : voList) &#123;</span><br><span class="line"></span><br><span class="line">	Method addMethod = vo.getClass().getMethod(getDocIDMethodInVo, <span class="keyword">new</span> Class[] &#123;&#125;);</span><br><span class="line"></span><br><span class="line">	Object result = addMethod.invoke(vo, <span class="keyword">new</span> Object[] &#123;&#125;);</span><br><span class="line"></span><br><span class="line">	 IndexRequestBuilder indexRequestBuilder = <span class="keyword">this</span>.esClient.prepareIndex(index, type, result.toString()).setSource(gson.toJson(vo));</span><br><span class="line">        bulkRequest.add(indexRequestBuilder);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span> (bulkRequest.numberOfActions() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          BulkResponse resp = bulkRequest.setRefresh(isAutoRefresh).execute().actionGet();</span><br><span class="line">          <span class="keyword">if</span> (resp.hasFailures()) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> Exception(String.format(<span class="string">"Bulk index items failed, message:%s"</span>, resp.buildFailureMessage()));</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="更新-Update"><a href="#更新-Update" class="headerlink" title="更新(Update)"></a>更新(Update)</h2><h3 id="1-根据ID执行update操作"><a href="#1-根据ID执行update操作" class="headerlink" title="1.根据ID执行update操作"></a>1.根据ID执行update操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * update Extra fields by document ID</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fieldValMap:key=index field, value = value to be update</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UpdateResponse <span class="title">update</span><span class="params">(String index, String type, String id, Map&lt;String, Object&gt; fieldValMap)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.esClient.update(<span class="keyword">new</span> UpdateRequest(index, type, id).refresh(<span class="keyword">true</span>).doc(fieldValMap)).get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-批量update"><a href="#2-批量update" class="headerlink" title="2.批量update"></a>2.批量update</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Update datas. Map key is doc_id, Map Value is update field-value map.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">bulkProcessUpdate</span><span class="params">(String index, String type, Map&lt;String, Map&lt;String, Object&gt;&gt; mapUpdates, <span class="keyword">boolean</span> isAutoRefresh)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    BulkRequestBuilder bulkRequest = <span class="keyword">this</span>.esClient.prepareBulk();</span><br><span class="line">    bulkRequest.setTimeout(TimeValue.timeValueMinutes(<span class="number">20</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String docId : mapUpdates.keySet()) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; mapUpdateFieldValue = mapUpdates.get(docId);</span><br><span class="line">        XContentBuilder jsonBuilder = XContentFactory.jsonBuilder().startObject();</span><br><span class="line">        <span class="keyword">for</span> (String key : mapUpdateFieldValue.keySet()) &#123;</span><br><span class="line">            jsonBuilder.field(key, mapUpdateFieldValue.get(key));</span><br><span class="line">        &#125;</span><br><span class="line">        jsonBuilder.endObject();</span><br><span class="line">        UpdateRequestBuilder updateRequestBuilder = <span class="keyword">this</span>.esClient.prepareUpdate(index, type, docId)</span><br><span class="line">                .setDoc(jsonBuilder);</span><br><span class="line">        bulkRequest.add(updateRequestBuilder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bulkRequest.numberOfActions() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        BulkResponse resp = bulkRequest.setRefresh(isAutoRefresh).execute().actionGet();</span><br><span class="line">        <span class="keyword">if</span> (resp.hasFailures()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(String.format(<span class="string">"Bulk update items failed, message:%s"</span>, resp.buildFailureMessage()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="删除-Delete"><a href="#删除-Delete" class="headerlink" title="删除(Delete)"></a>删除(Delete)</h2><h3 id="1-根据ID-删除"><a href="#1-根据ID-删除" class="headerlink" title="1.根据ID 删除"></a>1.根据ID 删除</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Delete data by id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteById</span><span class="params">(String index, String type, String id)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.esClient.prepareDelete(index, type, id).setRefresh(<span class="keyword">true</span>).execute().actionGet().isFound();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-批量删除"><a href="#2-批量删除" class="headerlink" title="2.批量删除"></a>2.批量删除</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bulk delete by document IDs</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> lstId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bulkProcessDelete</span><span class="params">(String index, String type, List&lt;String&gt; lstId)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> BulkProcessor bulkProcessor = BulkProcessor.builder(<span class="keyword">this</span>.esClient, <span class="keyword">new</span> BulkProcessor.Listener() &#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeBulk</span><span class="params">(<span class="keyword">long</span> executionId, BulkRequest request)</span> </span>&#123;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterBulk</span><span class="params">(<span class="keyword">long</span> executionId, BulkRequest request, BulkResponse response)</span> </span>&#123;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterBulk</span><span class="params">(<span class="keyword">long</span> executionId, BulkRequest request, Throwable failure)</span> </span>&#123;</span><br><span class="line">			failure.printStackTrace();</span><br><span class="line">			logger.error(<span class="string">"ElasticsearchHelper.bulkProcessDelete.Index is &#123;&#125;. error is &#123;&#125;. "</span>, index,</span><br><span class="line">					failure.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;).setBulkActions(BULK_MAX_SIZE).setBulkSize(<span class="keyword">new</span> ByteSizeValue(<span class="number">1</span>, ByteSizeUnit.GB))</span><br><span class="line">			.setFlushInterval(TimeValue.timeValueSeconds(<span class="number">5</span>)).build();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (String docId : lstId) &#123;</span><br><span class="line">			bulkProcessor.add(<span class="keyword">new</span> DeleteRequest(index, type, docId));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		logger.error(<span class="string">"ElasticsearchHelper.bulkProcessUpdateItems.Index is &#123;&#125;. error is &#123;&#125;. "</span>, ex);</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		bulkProcessor.awaitClose(<span class="number">1</span>, TimeUnit.MINUTES);</span><br><span class="line">		<span class="keyword">this</span>.esClient.admin().indices().prepareRefresh(index).get();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-根据DSL删除"><a href="#3-根据DSL删除" class="headerlink" title="3.根据DSL删除"></a>3.根据DSL删除</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Delete by query</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queryDsl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteByQueryDsl</span><span class="params">(String queryDsl , String index, String type, <span class="keyword">boolean</span> isAutoRefresh)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	</span><br><span class="line">	Client client = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		</span><br><span class="line">		client =<span class="keyword">this</span>.esClient;</span><br><span class="line"></span><br><span class="line">		SearchRequestBuilder searchBuilder = client.prepareSearch(index)</span><br><span class="line">					.setTypes(type)</span><br><span class="line">					.setExtraSource(queryDsl).setFrom(<span class="number">0</span>).setSize(<span class="number">1500</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>));</span><br><span class="line"></span><br><span class="line">		SearchResponse scrollResp = searchBuilder.execute().actionGet();</span><br><span class="line">	 </span><br><span class="line">		BulkRequestBuilder bulkRequest = client.prepareBulk();</span><br><span class="line">		bulkRequest.setTimeout(TimeValue.timeValueMinutes(<span class="number">20</span>));</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (SearchHit hit : scrollResp.getHits().getHits()) &#123;</span><br><span class="line">					bulkRequest.add(client.prepareDelete(index, type, hit.getId()));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			scrollResp = client.prepareSearchScroll(scrollResp.getScrollId()).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute().actionGet();</span><br><span class="line">				</span><br><span class="line">			<span class="comment">// Break condition: No hits are returned</span></span><br><span class="line">			<span class="keyword">if</span> (scrollResp.getHits().getHits().length == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (bulkRequest.numberOfActions() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			BulkResponse response = bulkRequest.setRefresh(isAutoRefresh).execute().actionGet();</span><br><span class="line">			<span class="keyword">if</span> (response.hasFailures()) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> Exception(</span><br><span class="line">						<span class="string">"deleteByFilter failure:"</span> + response.buildFailureMessage());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * delete documents By Query DSL</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dsl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteByQueryDsl</span><span class="params">(String index, String type, String dsl)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	String scrollId = <span class="string">""</span>;</span><br><span class="line">	List&lt;String&gt; lstId;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">		lstId = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">		SearchResponse scrollResp = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type).setExtraSource(dsl).setFrom(<span class="number">0</span>)</span><br><span class="line">				.setSize(<span class="number">2000</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute().actionGet();</span><br><span class="line">		scrollId = scrollResp.getScrollId();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (SearchHit searchHit : scrollResp.getHits().getHits()) &#123;</span><br><span class="line">				lstId.add(searchHit.getId());</span><br><span class="line">			&#125;</span><br><span class="line">			scrollResp = <span class="keyword">this</span>.esClient.prepareSearchScroll(scrollId).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute()</span><br><span class="line">					.actionGet();</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">while</span> (scrollResp.getHits().getHits().length &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.bulkProcessDelete(index, type, lstId);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>我们在执行ES操作的时候，为了避免一次操作的数据量过大，通常会设置size；因此，我们用到了scrollId；在方法finally中，需要将scrollId清除。<br>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearESScrollId</span><span class="params">(String scrollId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isNoneEmpty(scrollId)) &#123;</span><br><span class="line">			ClearScrollRequest clearScrollerRequest = <span class="keyword">new</span> ClearScrollRequest();</span><br><span class="line">			clearScrollerRequest.addScrollId(scrollId);</span><br><span class="line">			<span class="keyword">this</span>.esClient.clearScroll(clearScrollerRequest).actionGet();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/30/4.ElasticSearch%E5%B8%B8%E7%94%A8%E7%9A%84%E5%A2%9E%E5%88%A0%E6%9F%A5%E6%94%B9%E6%93%8D%E4%BD%9C/" data-id="ck52gfk4g000368v13hjw6fxg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/01/06/2.Docker%20%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          2.Docker 常用操作
        
      </div>
    </a>
  
  
    <a href="/2019/12/30/3.Windows%E7%B3%BB%E7%BB%9F%E5%90%91ElasticSearch%20bulk%E6%89%B9%E9%87%8F%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">3.Windows系统向ElasticSearch bulk批量同步数据</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/01/06/2.Docker%20%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/">2.Docker 常用操作</a>
          </li>
        
          <li>
            <a href="/2019/12/30/4.ElasticSearch%E5%B8%B8%E7%94%A8%E7%9A%84%E5%A2%9E%E5%88%A0%E6%9F%A5%E6%94%B9%E6%93%8D%E4%BD%9C/">4.ElasticSearch常用的增删查改操作</a>
          </li>
        
          <li>
            <a href="/2019/12/30/3.Windows%E7%B3%BB%E7%BB%9F%E5%90%91ElasticSearch%20bulk%E6%89%B9%E9%87%8F%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE/">3.Windows系统向ElasticSearch bulk批量同步数据</a>
          </li>
        
          <li>
            <a href="/2019/12/18/1.Docker%E7%AE%80%E4%BB%8B%E5%8F%8A%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">1.Docker简介及环境搭建</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Damon Liu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>