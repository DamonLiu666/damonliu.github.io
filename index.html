<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Learning Paradise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Learning Paradise">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;index.html">
<meta property="og:site_name" content="Learning Paradise">
<meta property="article:author" content="Damon Liu">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Learning Paradise" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Learning Paradise</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-SpringCloud Eureka" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/10/SpringCloud%20Eureka/" class="article-date">
  <time datetime="2020-02-10T11:28:24.734Z" itemprop="datePublished">2020-02-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/10/SpringCloud%20Eureka/">SpringCloud Eureka</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="服务注册与发现-Eureka"><a href="#服务注册与发现-Eureka" class="headerlink" title="服务注册与发现 Eureka"></a>服务注册与发现 Eureka</h1><h2 id="1-Eureka是什么"><a href="#1-Eureka是什么" class="headerlink" title="1.Eureka是什么"></a>1.Eureka是什么</h2><p>Eurekdiaoya是Netflix的一个子模块。</p>
<p>是基于Rest的服务，用于定位服务，以实现云端中间层服务发现和故障转移。</p>
<p>有了服务发现与注册，只需要使用服务的标识符，就可以访问到服务，而不需要修改服务调用的配置文件了。</p>
<p>功能类似于dubbo的注册中心，比如Zookeeper。</p>
<h2 id="2-Eureka基本架构"><a href="#2-Eureka基本架构" class="headerlink" title="2.Eureka基本架构"></a>2.Eureka基本架构</h2><p>采用C - S的设计架构。Eureka Server作为服务注册功能的服务器，是服务注册中心。</p>
<p>系统中的其他微服务，使用Eureka Client端连接到Eureka Server并维持心跳连接。</p>
<p>系统维护人员可以通过Eureka Server来监控各个微服务是否正常运行。</p>
<p>Spring Cloud的其他模块(比如Zuul)就可以通过Eureka Server来发现系统中其他微服务，并执行相关的逻辑。</p>
<p>Eureka Client是一个Java客户端，用于简化Eureka Server的交互，同时也具备一个内置的、使用轮询(dound-robin)堵在算法的负载均衡器。在容器移动后，将会像Eureka Server发送心跳(默认周期30s)。如果Eureka Server在多个心跳周期内没有收到某个节点的心跳。Eureka Server将会从服务注册表中把这个服务节点移除(默认90s)</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CDesktop%5C%E5%BE%AE%E6%9C%8D%E5%8A%A1%5CEureka%E6%9E%B6%E6%9E%84.PNG" alt="Eureka架构"></p>
<h2 id="3-Eureka三大角色"><a href="#3-Eureka三大角色" class="headerlink" title="3.Eureka三大角色"></a>3.Eureka三大角色</h2><ul>
<li>Eureka Server提供服务注册和发现</li>
<li>Service Provider将自身服务注册到Eureka，从而使服务消费放能够找到</li>
<li>Service Consumer从Eureka获取注册服务列表，从而消费服务</li>
</ul>
<h2 id="4-构建步骤"><a href="#4-构建步骤" class="headerlink" title="4.构建步骤"></a>4.构建步骤</h2><ul>
<li><p>在父工程目录上new一个Maven Module，Packaging选择jar。做为Eureka Server。</p>
<ul>
<li><p>pom文件引入spring-cloud-starter-euraka-server依赖</p>
</li>
<li><p>src/mian/resource路径下配置application.yml</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CDesktop%5C%E5%BE%AE%E6%9C%8D%E5%8A%A1%5CEureka_yml.PNG" alt="Eureka_yml"></p>
</li>
<li><p>Eureka Server主启动类  </p>
<p>@SpringBootApplication</p>
<p>@EnableEurekaServer(EurekaServer启动类，接受其他微服务注册进来)</p>
</li>
</ul>
</li>
<li><p>将Service Provider注册到Eureka Server。</p>
<ul>
<li><p>在Service Provider pom文件引入依赖:</p>
<p>spring-cloud-starter-eureka</p>
<p>spring-cloud-starter-config</p>
</li>
<li><p>修改Service Provider application.yml</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CDesktop%5C%E5%BE%AE%E6%9C%8D%E5%8A%A1%5CEureka_client_yml.PNG" alt="Eureka_client_yml"></p>
</li>
<li><p>修改Service Provider主启动类</p>
<p>@EnableEurekaClient(服务启动后会自动注册到Eureka)</p>
</li>
</ul>
</li>
<li><p>actuator与注册微服务信息完善</p>
<ul>
<li><p>主机名称：服务名称修改</p>
<p>修改Service Peovider application.yml</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CDesktop%5C%E5%BE%AE%E6%9C%8D%E5%8A%A1%5CEureka_client_yml01.PNG" alt="Eureka_client_yml01"></p>
</li>
<li><p>访问信息有IP信息提示</p>
<p>修改Service Peovider application.yml</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1581324558809.png" alt="1581324558809"></p>
</li>
<li><p>微服务info内容详细信息</p>
<p>在Service Provider pom文件新增spring-boot-starter-actuator依赖</p>
<p>在父工程pom文件新增构建信息</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1581325162322.png" alt="1581325162322"></p>
<p>修改Service Peovider application.yml</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CDesktop%5C%E5%BE%AE%E6%9C%8D%E5%8A%A1%5CEureka_client_yml02.PNG" alt="Eureka_client_yml02"></p>
</li>
</ul>
</li>
<li><p>Eureka自我保护机制</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1581327793296.png" alt="1581327793296"></p>
<p>某时刻某一个微服务不可用了，eureka不会立即清理，依旧会对该微服务的信息进行保存。(防止由于网络原因引起的连接问题，体现出了Eureka的高可用和可容错)</p>
<p>在Eureka Server的yml文件中配置eureka.server.enable-self-preservation: false可以禁用自我保护机制，但不建议此操作。</p>
</li>
<li><p>服务发现</p>
<p>对于注册到Eureka的微服务，可以通过服务大仙来回的该服务的信息</p>
<ul>
<li><p>在Service Provider 的controller新增DiscoveryClient API</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CDesktop%5C%E5%BE%AE%E6%9C%8D%E5%8A%A1%5CEureka_discovery.png" alt="Eureka_discovery"></p>
</li>
<li><p>在Service Provider 的主启动类新增注解@EnableDiscoveryClient(服务发现)</p>
</li>
<li><p>在Service Consumer 的Controller新增discovery API<img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CDesktop%5C%E5%BE%AE%E6%9C%8D%E5%8A%A1%5CEureka_discovery_consumer.png" alt="Eureka_discovery_consumer"></p>
</li>
</ul>
</li>
</ul>
<h2 id="5-Eureka集群配置"><a href="#5-Eureka集群配置" class="headerlink" title="5.Eureka集群配置"></a>5.Eureka集群配置</h2><ul>
<li><p>在父工程目录上new两个Maven Module，Packaging选择jar</p>
</li>
<li><p>pom文件引入相同的依赖</p>
</li>
<li><p>建立主启动类</p>
</li>
<li><p>修改映射配置文件</p>
<p>windows下找到C:\Windows\System32\drivers\etc下的host文件添加如下内容：</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1581331304637.png" alt="1581331304637"></p>
</li>
<li><p>三个Eureka Server配置yml，修改hostname和defaultZone</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1581331551233.png" alt="1581331551233"></p>
</li>
<li><p>修改Service Provider 的yml，将三台Eureka Server的地址添加到defaultZone</p>
</li>
<li><p>测试</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1581331934733.png" alt="1581331934733"></p>
</li>
</ul>
<h2 id="6-作为服务注册中心，Eureka对比Zookeeper的优势"><a href="#6-作为服务注册中心，Eureka对比Zookeeper的优势" class="headerlink" title="6.作为服务注册中心，Eureka对比Zookeeper的优势"></a>6.作为服务注册中心，Eureka对比Zookeeper的优势</h2><ul>
<li><p>Zookeeper遵守CP</p>
<p>当zk的master节点一位内网络故障和其他节点失去联系时，剩余节点会重新进行leader选举，但这个时间比较长(30s~120s)，在此期间zk集群是不可用的，注册服务会瘫痪。</p>
</li>
</ul>
<ul>
<li><p>Eureka 遵守AP</p>
<p>只要有一台Eureka还在，就能保证服务可用(高可用性)，只不过查到的信息可能不是最新的(不保证强一致性)。</p>
<p>Eureka还有自我保护机制，如果在15min内85%的节点没有正常心跳，那么Eureka会认为和不断与注册中心出现网络故障，会出现以下几种情况：</p>
<p>1.Eureka不再从注册列表中移除因为长时间没收到心跳而应该过期的服务</p>
<p>2.Eureka依然能够接受新服务的注册和查询请求，但不会被同步到其他节点上(保证当前节点依然可用)</p>
<p>3.当网络稳定后，当前实例心的注册信息会被同步到其他节点中</p>
</li>
</ul>
<p>补充：</p>
<p>RDBMS(MySQL/Oracle/sqlServer)  —-&gt; ACID(原子性、一致性、隔离性、持久性)</p>
<p>NOSQL(redis/mongdb) —-&gt; CAP(强一致性、高可用性、分区容错性)</p>
<p><img src="/2020/02/10/SpringCloud%20Eureka/C:%5CUsers%5Cliujun%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1581332583650.png" alt="1581332583650"></p>
<p>在分布式系统中，肯定存在由于网络或硬件导致的延迟丢包问题，所以，分区容错性(P)必须实现。故只能在A和C中二选一</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/10/SpringCloud%20Eureka/" data-id="ck6ge63yo0000ecv17duk9rmu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-SpringCloud微服务工程构建" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/10/SpringCloud%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%B7%A5%E7%A8%8B%E6%9E%84%E5%BB%BA/" class="article-date">
  <time datetime="2020-02-10T11:28:20.665Z" itemprop="datePublished">2020-02-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/10/SpringCloud%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%B7%A5%E7%A8%8B%E6%9E%84%E5%BB%BA/">SpringCloud微服务工程构建</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="SpringCloud微服务工程构建"><a href="#SpringCloud微服务工程构建" class="headerlink" title="SpringCloud微服务工程构建"></a>SpringCloud微服务工程构建</h1><h2 id="1-父工程构建"><a href="#1-父工程构建" class="headerlink" title="1.父工程构建"></a>1.父工程构建</h2><ul>
<li><p>new 一个Maven Project，Packaging选择pom。</p>
<p>主要是定义pom文件，将后续各个子模块公用的jar包统一提取出来，类似于一个抽象父类</p>
</li>
</ul>
<h2 id="2-API公共模块构建"><a href="#2-API公共模块构建" class="headerlink" title="2.API公共模块构建"></a>2.API公共模块构建</h2><ul>
<li><p>在父工程目录上new一个Maven Module，Packaging选择jar。</p>
<p>此时父工程pom文件中会出现公共模块</p>
</li>
<li><p>在公共模块的pom文件中按需添加依赖</p>
</li>
<li><p>公共模块功能实现</p>
</li>
<li><p>maven clean</p>
</li>
<li><p>maven install</p>
</li>
</ul>
<p>在公共模块中可以定义公用的实体类，由于微服务每个模块可以使用不同的数据库，所以在定义实体类时，可以定义一个String字段用来和数据库名称对应。</p>
<p>实体类建立：</p>
<ul>
<li>pom文件添加lombok依赖</li>
<li>实体类 implements Serializable    必须序列化</li>
<li>@AllArgsConstructor    全参构造方法</li>
<li>@NoArgsConstructor    空参构造方法</li>
<li>@Data    setter 和 getter 方法</li>
<li>@Accessors(chain = true)    链式风格</li>
</ul>
<h2 id="3-Provider工程构建"><a href="#3-Provider工程构建" class="headerlink" title="3.Provider工程构建"></a>3.Provider工程构建</h2><ul>
<li>在父工程目录上new一个Maven Module，Packaging选择jar</li>
<li>pom文件引入API公共模块及需要的依赖</li>
<li>src/mian/resource路径下配置application.yml<ul>
<li>server port</li>
<li>mybatis整合(config路径，entity路径，mapper路径)</li>
<li>spring整合(name,datasource)</li>
</ul>
</li>
<li>src/mian/resource路径下新建mybatis文件夹，配置mybatis.cfg.xml文件<ul>
<li>开启二级缓存</li>
</ul>
</li>
<li>mysql 数据库脚本(建表)</li>
<li>Dao层，@Mapper注解</li>
<li>src/mian/resource/mybatis路径下新建mapper文件夹，新建与dao对应的xml文件</li>
<li>Service 接口</li>
<li>ServiceImpl 实现类，@Service注解</li>
<li>Controller 提供REST，@RestController注解</li>
<li>服务主启动类</li>
</ul>
<h2 id="4-Consumer工程构建"><a href="#4-Consumer工程构建" class="headerlink" title="4.Consumer工程构建"></a>4.Consumer工程构建</h2><ul>
<li>在父工程目录上new一个Maven Module，Packaging选择jar</li>
<li>pom文件引入API公共模块及需要的依赖</li>
<li>src/mian/resource路径下配置application.yml<ul>
<li>server port</li>
</ul>
</li>
<li>在工程目录下新建文件夹cfgbeans，新建ConfigBean.java，@Configuration注解<ul>
<li>getRestTemplate()，返回RestTemplate，用@Bean注解。</li>
</ul>
</li>
<li>Controller，使用RestTemplate调用对应方法返回</li>
<li>服务主启动类</li>
</ul>
<p>RestTemplate：</p>
<p>提供了多种便捷访问远程Http服务的方法，</p>
<p>是一种简单便捷的访问restful服务模块类，是Spring提供的用于访问Rest服务的客户端模板工具集。</p>
<p>(url，requestMap，ResponseBean.class)这三个参数分别代表：REST请求地址，请求参数，HTTP响应被转换成的对象类型</p>
<h2 id="5-测试"><a href="#5-测试" class="headerlink" title="5.测试"></a>5.测试</h2><ul>
<li>启动Provider和Consumer工程</li>
<li>使用Consumer工程URL访问，查看结果</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/10/SpringCloud%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%B7%A5%E7%A8%8B%E6%9E%84%E5%BB%BA/" data-id="ck6ge63z30001ecv13lo777ea" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-SpringCloud概述" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/10/SpringCloud%E6%A6%82%E8%BF%B0/" class="article-date">
  <time datetime="2020-02-10T11:28:17.104Z" itemprop="datePublished">2020-02-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/10/SpringCloud%E6%A6%82%E8%BF%B0/">SpringCloud概述</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="SpringCloud-概述"><a href="#SpringCloud-概述" class="headerlink" title="SpringCloud 概述"></a>SpringCloud 概述</h1><h2 id="1-SpringCloud和SpringBoot的关系"><a href="#1-SpringCloud和SpringBoot的关系" class="headerlink" title="1.SpringCloud和SpringBoot的关系"></a>1.SpringCloud和SpringBoot的关系</h2><ul>
<li>SpringBoot关注于快速便捷的开发单个个体微服务</li>
<li>SpringCloud是关注于全局的微服务协调整理治理框架，将SpringBoot开发的一个个单体微服务整合并管理起来</li>
<li>springBoot可以离开SpringCloud独立开发项目，反之不可，是依赖关系</li>
</ul>
<h2 id="2-SpringClooud和Dubbo对比"><a href="#2-SpringClooud和Dubbo对比" class="headerlink" title="2.SpringClooud和Dubbo对比"></a>2.SpringClooud和Dubbo对比</h2><table>
<thead>
<tr>
<th></th>
<th>Dubbo</th>
<th>SpringCloud</th>
</tr>
</thead>
<tbody><tr>
<td>服务注册中心</td>
<td>Zookeeper</td>
<td>Spring Cloud  Netflix Eureka</td>
</tr>
<tr>
<td>服务调用方式</td>
<td>RPC</td>
<td>Rest API</td>
</tr>
<tr>
<td>服务监控</td>
<td>Dubbo-monitor</td>
<td>Spring Boot Admin</td>
</tr>
<tr>
<td>断路器</td>
<td>不完善</td>
<td>Spring Cloud Netflix Hystrix</td>
</tr>
<tr>
<td>服务网关</td>
<td>无</td>
<td>Spring Cloud Netflix Zuul</td>
</tr>
<tr>
<td>分布式配置</td>
<td>无</td>
<td>Spring Cloud Config</td>
</tr>
<tr>
<td>服务跟踪</td>
<td>无</td>
<td>Spring Cloud Sleuth</td>
</tr>
<tr>
<td>消息总线</td>
<td>无</td>
<td>Spring Cloud Bus</td>
</tr>
<tr>
<td>数据流</td>
<td>无</td>
<td>Spring Cloud Stream</td>
</tr>
<tr>
<td>批量任务</td>
<td>无</td>
<td>Spring Cloud Task</td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/10/SpringCloud%E6%A6%82%E8%BF%B0/" data-id="ck6ge63z80002ecv11uda4ra4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-微服务概述" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/06/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0/" class="article-date">
  <time datetime="2020-02-06T14:14:50.562Z" itemprop="datePublished">2020-02-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/06/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0/">微服务概述</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="微服务概述"><a href="#微服务概述" class="headerlink" title="微服务概述"></a>微服务概述</h1><h2 id="1-什么是微服务架构"><a href="#1-什么是微服务架构" class="headerlink" title="1.什么是微服务架构"></a>1.什么是微服务架构</h2><ul>
<li>微服务架构是一种架构模式或者说是一种架构风格</li>
<li>将单一应用程序按业务划分成一组小的服务，每个服务运行在其独立的进程中。服务之间互相调用、配合，为用户提供最终价值</li>
<li>服务之间采用轻量级的通信机制进行沟通(通常是基于HTTP的RESTful API)</li>
<li>每个服务独立部署、发布</li>
</ul>
<h2 id="2-什么是微服务"><a href="#2-什么是微服务" class="headerlink" title="2.什么是微服务"></a>2.什么是微服务</h2><ul>
<li><p>强调的是服务的大小，每个服务个体完成一个具体的任务或功能</p>
<p>狭义的可以理解为是eclipse里的一个个工程</p>
</li>
</ul>
<h2 id="3-微服务优缺点"><a href="#3-微服务优缺点" class="headerlink" title="3.微服务优缺点"></a>3.微服务优缺点</h2><ul>
<li>优点<ul>
<li>每个服务足够小，代码容易理解。每个服务能聚焦一个指定的业务功能或业务需求</li>
<li>易于被小团队开发、修改和维护</li>
<li>松耦合，是有功能意义的服务，无论是在开发阶段还是部署阶段都是独立的</li>
<li>微服务能使用不同的语言开发</li>
<li>易于和第三方集成，允许容易且灵活的方式集成自动部署，通过持续集成工具，如Jenkins</li>
<li>只是业务逻辑的代码，不会和HTML、CSS或其他页面组件混合</li>
<li>每个微服务可以使用自己独立的数据库，也可以共用一个数据库</li>
</ul>
</li>
<li>缺点<ul>
<li>需要处理分布式系统的复杂性</li>
<li>多服务运维难度增加</li>
<li>系统部署依赖</li>
<li>服务间有通信成本</li>
<li>数据一致性</li>
<li>系统集成测试麻烦</li>
<li>性能监控复杂</li>
</ul>
</li>
</ul>
<h2 id="4-微服务技术栈"><a href="#4-微服务技术栈" class="headerlink" title="4.微服务技术栈"></a>4.微服务技术栈</h2><table>
<thead>
<tr>
<th>微服务条目</th>
<th>落地技术</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>服务开发</td>
<td>SpringBoot、Spring、SpringMVC</td>
<td></td>
</tr>
<tr>
<td>服务配置与管理</td>
<td>Netflix公司的Archaius、阿里的Diamond等</td>
<td></td>
</tr>
<tr>
<td>服务注册与发现</td>
<td>Eureka、Consul、Zookeeper</td>
<td></td>
</tr>
<tr>
<td>服务调用</td>
<td>Rest、RPC、gRPC</td>
<td></td>
</tr>
<tr>
<td>服务熔断器</td>
<td>Hystrix、Envoy</td>
<td></td>
</tr>
<tr>
<td>负载均衡</td>
<td>Ribbon、Nginx</td>
<td></td>
</tr>
<tr>
<td>服务接口调用(客户端调用服务的简化工具)</td>
<td>Feign</td>
<td></td>
</tr>
<tr>
<td>消息队列</td>
<td>Kafka、RabbitMQ、ActiveMQ</td>
<td></td>
</tr>
<tr>
<td>服务配置中心管理</td>
<td>SpringCloudConfig、Chef</td>
<td></td>
</tr>
<tr>
<td>服务路由(API网关)</td>
<td>Zuul</td>
<td></td>
</tr>
<tr>
<td>服务监控</td>
<td>Zabbix、Nagios、Metrics、Spectator</td>
<td></td>
</tr>
<tr>
<td>全链路追踪</td>
<td>Zipkin、Brave、Dapper</td>
<td></td>
</tr>
<tr>
<td>服务部署</td>
<td>Docker、OpenStack、K8S</td>
<td></td>
</tr>
<tr>
<td>数据流操作开发包</td>
<td>SpringCloud Stream(封装Redis、Rabbit、Kafka等发送接收消息)</td>
<td></td>
</tr>
<tr>
<td>事件消息总线</td>
<td>SpringCloud Bus</td>
<td></td>
</tr>
</tbody></table>
<h2 id="5-各微服务框架对比"><a href="#5-各微服务框架对比" class="headerlink" title="5.各微服务框架对比"></a>5.各微服务框架对比</h2><table>
<thead>
<tr>
<th>功能点/服务框架</th>
<th>Spring Cloud</th>
<th>Motan</th>
<th>gRPC</th>
<th>Thrift</th>
<th>Dubbo</th>
</tr>
</thead>
<tbody><tr>
<td>功能定位</td>
<td>完整的微服务框架</td>
<td>RPC框架，但整合了ZK或Consul，实现集群环境的基本服务注册和发现</td>
<td>RPC框架</td>
<td>RPC框架</td>
<td>RPC框架</td>
</tr>
<tr>
<td>支持Rest</td>
<td>是，Ribbon支持多种可插拔的序列化选择</td>
<td>否</td>
<td>否</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>支持RPC</td>
<td>否</td>
<td>是</td>
<td>是</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>支持多语言</td>
<td>是</td>
<td>否</td>
<td>是</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>服务注册/发现</td>
<td>是(Eureka)   Eureka服务注册表，Karyon服务端框架支持服务自注册和健康检查</td>
<td>是(Zookeeper/Consul)</td>
<td>否</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>负载均衡</td>
<td>是(服务端Zuul+客户端Ribbon)</td>
<td>是(客户端)</td>
<td>否</td>
<td>否</td>
<td>是(客户端)</td>
</tr>
<tr>
<td>配置服务</td>
<td>Netflix Archaius  SpringCloud Config Server集中配置</td>
<td>是(Zookeeper提供)</td>
<td>否</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>服务调用链监控</td>
<td>是(Zuul)  Zuul提供边缘服务，API网关</td>
<td>否</td>
<td>否</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>高可用/容错</td>
<td>是(服务端Hystrix+客户端Ribbon)</td>
<td>是(客户端)</td>
<td>否</td>
<td>否</td>
<td>是(客户端)</td>
</tr>
<tr>
<td>典型应用案例</td>
<td>Netflix</td>
<td>Sina</td>
<td>Google</td>
<td>Facebook</td>
<td></td>
</tr>
<tr>
<td>其他</td>
<td>Spring Cloud Bus为我们的应用程序带来了更多的管理端点</td>
<td>支持降级</td>
<td>Netflix内部开发集成gRPC</td>
<td>IDL定义</td>
<td></td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/06/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0/" data-id="ck6ge63zu0006ecv1d2000tmf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Docker常用操作" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/06/Docker%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/" class="article-date">
  <time datetime="2020-01-06T12:58:29.733Z" itemprop="datePublished">2020-01-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/06/Docker%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/">Docker常用操作</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Docker-常用操作"><a href="#Docker-常用操作" class="headerlink" title="Docker 常用操作"></a>Docker 常用操作</h1><h2 id="1-安装镜像"><a href="#1-安装镜像" class="headerlink" title="1.安装镜像"></a>1.安装镜像</h2><p>以mysql为例</p>
<h3 id="查询镜像"><a href="#查询镜像" class="headerlink" title="查询镜像"></a>查询镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search mysql</span><br></pre></td></tr></table></figure>

<p><img src="/2020/01/06/Docker%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/C:%5CUsers%5Cliujun%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1577711432781.png" alt="1577711432781"></p>
<p>注意：OFFICIAL这一栏位带有“OK”的，是官方镜像</p>
<h3 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql</span><br></pre></td></tr></table></figure>

<p>此时下载的是latest版本的镜像</p>
<h3 id="拉取指定版本的镜像"><a href="#拉取指定版本的镜像" class="headerlink" title="拉取指定版本的镜像"></a>拉取指定版本的镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.5</span><br></pre></td></tr></table></figure>

<p>拉取指定版本的镜像，需要带上对应的tag</p>
<p>tag可以到docker hub 查找( <a href="https://hub.docker.com/" target="_blank" rel="noopener">https://hub.docker.com/</a> )</p>
<h3 id="查看安装好的镜像"><a href="#查看安装好的镜像" class="headerlink" title="查看安装好的镜像"></a>查看安装好的镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>

<p><img src="/2020/01/06/Docker%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/C:%5CUsers%5Cliujun%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1577715029994.png" alt="1577715029994"></p>
<h3 id="删除docker-镜像"><a href="#删除docker-镜像" class="headerlink" title="删除docker 镜像"></a>删除docker 镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi XXX</span><br></pre></td></tr></table></figure>

<p>删除的时候，需带上对应的image id</p>
<h2 id="2-容器操作"><a href="#2-容器操作" class="headerlink" title="2.容器操作"></a>2.容器操作</h2><p>软件镜像—-&gt;运行镜像—-&gt;产生一个容器(正在运行的软件)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">1.搜索镜像</span><br><span class="line">	docker search tomcat</span><br><span class="line">2.拉取镜像</span><br><span class="line">	docker pull tomcat</span><br><span class="line">3.启动容器</span><br><span class="line">	docker run --name mytomcat -d tomcat:latest</span><br><span class="line">	(--name后面的名称自己取；	-d 表示后台运行)</span><br><span class="line">4.查看运行的容器</span><br><span class="line">	docker ps</span><br><span class="line">5.停止正在运行的容器</span><br><span class="line">	docker stop mytomcat</span><br><span class="line">6.查看所有的容器(包括运行中的和已停止的)</span><br><span class="line">	docker ps -a</span><br><span class="line">7.重新启动容器</span><br><span class="line">	docker start 容器id</span><br><span class="line">8.删除容器</span><br><span class="line">	docker rm 容器id</span><br><span class="line">9.启动一个做了端口映射的容器</span><br><span class="line">	docker run --name mytomcat -d -p 8888:8080 tomcat:latest</span><br><span class="line">	-p 将主机的一个端口映射到容器的端口			主机端口:容器内部的端口</span><br><span class="line">10.查看容器日志</span><br><span class="line">	docker logs 容器id</span><br></pre></td></tr></table></figure>

<p><img src="/2020/01/06/Docker%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/C:%5CUsers%5Cliujun%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1577718924925.png" alt="1577718924925"></p>
<p>第9步启动后，通过访问虚拟机IP地址+8888端口，可以查看tomcat是否启动成功</p>
<p><img src="/2020/01/06/Docker%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/C:%5CUsers%5Cliujun%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1577719013811.png" alt="1577719013811"></p>
<p>注意:如果访问tomcat失败，查看linux防火墙状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service firewalld status		查看防火墙状态</span><br><span class="line">service firewalld stop			关闭防火墙</span><br></pre></td></tr></table></figure>



<h2 id="3-安装mysql"><a href="#3-安装mysql" class="headerlink" title="3.安装mysql"></a>3.安装mysql</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.7</span><br><span class="line"></span><br><span class="line">docker run -p 3306:3306 --name mysql01 -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7</span><br></pre></td></tr></table></figure>

<p><img src="/2020/01/06/Docker%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/C:%5CUsers%5Cliujun%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1578315011651.png" alt="1578315011651"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/06/Docker%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/" data-id="ck6ge63za0003ecv1foue9iec" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ElasticSearch常用的增删查改操作" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/30/ElasticSearch%E5%B8%B8%E7%94%A8%E7%9A%84%E5%A2%9E%E5%88%A0%E6%9F%A5%E6%94%B9%E6%93%8D%E4%BD%9C/" class="article-date">
  <time datetime="2019-12-30T12:28:10.070Z" itemprop="datePublished">2019-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/30/ElasticSearch%E5%B8%B8%E7%94%A8%E7%9A%84%E5%A2%9E%E5%88%A0%E6%9F%A5%E6%94%B9%E6%93%8D%E4%BD%9C/">ElasticSearch常用的增删查改操作</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ElasticSearch常用的增删查改操作"><a href="#ElasticSearch常用的增删查改操作" class="headerlink" title="ElasticSearch常用的增删查改操作"></a>ElasticSearch常用的增删查改操作</h1><p>使用Java对ElasticSearch增删查改操作，分为两个步骤：<br>1.拼接sql语句<br>2.执行增删查改操作<br>以下提供了一些常用的轮子。</p>
<h2 id="sql拼接"><a href="#sql拼接" class="headerlink" title="sql拼接"></a>sql拼接</h2><h3 id="1-最普通的sql拼接"><a href="#1-最普通的sql拼接" class="headerlink" title="1.最普通的sql拼接"></a>1.最普通的sql拼接</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get query DSL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queryString</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Query DSL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getQueryDSL</span><span class="params">(String queryString)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	String dsl = <span class="string">"&#123;"</span> + <span class="string">" \"query\": &#123; "</span> + <span class="string">" \"query_string\": &#123; "</span> + <span class="string">" \"query\":\""</span> + queryString + <span class="string">"\" "</span> + <span class="string">"&#125;"</span> + <span class="string">" &#125; "</span></span><br><span class="line">			+ <span class="string">" &#125; "</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dsl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-查询并根据字段排序"><a href="#2-查询并根据字段排序" class="headerlink" title="2.查询并根据字段排序"></a>2.查询并根据字段排序</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get query DSL with sort</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sortByASCOrDesc : key:sort field, value: asc or desc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> query DSL with sort</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getQueryDSL</span><span class="params">(String queryString, Map&lt;String, String&gt; sortByASCOrDesc)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	String dsl = <span class="string">"&#123;"</span> + <span class="string">" \"query\": &#123; "</span> + <span class="string">" \"query_string\": &#123; "</span> + <span class="string">" \"query\":\""</span> + queryString + <span class="string">"\" "</span> + <span class="string">"&#125;"</span> + <span class="string">" &#125; "</span>;</span><br><span class="line"></span><br><span class="line">	StringBuilder builder = <span class="keyword">new</span> StringBuilder(dsl);</span><br><span class="line"></span><br><span class="line">	builder.append(<span class="string">", \"sort\": ["</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; pars : sortByASCOrDesc.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">			builder.append(String.format(<span class="string">"&#123;\"%s\":\"%s\"&#125;"</span>, pars.getKey(), pars.getValue()));</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			builder.append(String.format(<span class="string">",&#123;\"%s\":\"%s\"&#125;"</span>, pars.getKey(), pars.getValue()));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		index++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	builder.append(<span class="string">"]"</span>);</span><br><span class="line">	 </span><br><span class="line">	builder.append(<span class="string">" &#125; "</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> builder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-查询区间并排序"><a href="#3-查询区间并排序" class="headerlink" title="3.查询区间并排序"></a>3.查询区间并排序</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get query DSL with range</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;queryString&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;rangeMap: Key = range field, value = key = gte or gt or lte or lt, value = value &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; sortByASCOrDesc: key:sort field, value: asc or desc. input null if no need sort &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> query DSL with range</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getRangeQueryDSL</span><span class="params">(String queryString, Map&lt;String, Map&lt;String, String&gt;&gt; rangeMap, Map&lt;String, String&gt; sortByASCOrDesc)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	StringBuilder strBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">	strBuilder.append(<span class="string">"&#123;"</span>).append(<span class="string">"\"query\": &#123;"</span>)</span><br><span class="line">	.append(<span class="string">"\"bool\": &#123;"</span>).append(<span class="string">"\"must\": ["</span>).append(<span class="string">"&#123;"</span>)</span><br><span class="line">			.append(<span class="string">"\"query_string\": &#123;"</span>).append(<span class="string">" \"query\":\""</span> + queryString + <span class="string">"\" "</span>).append(<span class="string">"&#125;"</span>).append(<span class="string">"&#125;,"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> jj = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (Map.Entry&lt;String, Map&lt;String, String&gt;&gt; pair : rangeMap.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">		String field = pair.getKey();</span><br><span class="line"></span><br><span class="line">		Map&lt;String, String&gt; range = pair.getValue();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (jj == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">			strBuilder.append(<span class="string">"&#123;"</span>).append(<span class="string">"\"range\": &#123;"</span>).append(<span class="string">" \""</span> + field + <span class="string">"\": &#123; "</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">int</span> ii = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; map : range.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (ii == <span class="number">0</span> &amp;&amp; range.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">					strBuilder.append(<span class="string">" \""</span> + map.getKey() + <span class="string">"\": \""</span> + map.getValue() + <span class="string">"\" , "</span>);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					strBuilder.append(<span class="string">" \""</span> + map.getKey() + <span class="string">"\": \""</span> + map.getValue() + <span class="string">"\"  "</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				ii++;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">			strBuilder.append(<span class="string">"&#125;"</span>).append(<span class="string">"&#125;"</span>).append(<span class="string">"&#125;"</span>);</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">			strBuilder.append(<span class="string">",&#123;"</span>).append(<span class="string">"\"range\": &#123;"</span>).append(<span class="string">" \""</span> + field + <span class="string">"\": &#123; "</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">int</span> ii = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; map : range.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (ii == <span class="number">0</span> &amp;&amp; range.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">					strBuilder.append(<span class="string">" \""</span> + map.getKey() + <span class="string">"\": \""</span> + map.getValue() + <span class="string">"\" , "</span>);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					strBuilder.append(<span class="string">" \""</span> + map.getKey() + <span class="string">"\": \""</span> + map.getValue() + <span class="string">"\"  "</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				ii++;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">			strBuilder.append(<span class="string">"&#125;"</span>).append(<span class="string">"&#125;"</span>).append(<span class="string">"&#125;"</span>);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		jj++;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	strBuilder.append(<span class="string">"]"</span>).append(<span class="string">"&#125;"</span>).append(<span class="string">"&#125;"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(sortByASCOrDesc !=<span class="keyword">null</span>)&#123;</span><br><span class="line">		</span><br><span class="line">		strBuilder.append(<span class="string">", \"sort\": ["</span>);</span><br><span class="line"></span><br><span class="line">		jj = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; pars : sortByASCOrDesc.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (jj == <span class="number">0</span>) &#123;</span><br><span class="line">				strBuilder.append(String.format(<span class="string">"&#123;\"%s\":\"%s\"&#125;"</span>, pars.getKey(), pars.getValue()));</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				strBuilder.append(String.format(<span class="string">",&#123;\"%s\":\"%s\"&#125;"</span>, pars.getKey(), pars.getValue()));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			jj++;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		 strBuilder.append(<span class="string">"]"</span>);</span><br><span class="line">		 </span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">	strBuilder.append(<span class="string">"&#125;"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> strBuilder.toString();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-查所有"><a href="#4-查所有" class="headerlink" title="4.查所有"></a>4.查所有</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getQueryAllDSL</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	String dsl = <span class="string">"&#123; "</span> + <span class="string">" \"query\": &#123; "</span> + <span class="string">" \"match_all\": &#123;&#125; "</span> + <span class="string">" &#125; "</span> + <span class="string">" &#125; "</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dsl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-根据字段分组"><a href="#5-根据字段分组" class="headerlink" title="5.根据字段分组"></a>5.根据字段分组</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getAggsQueryDsl</span><span class="params">(String queryString, String strAggs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">    <span class="string">"&#123;"</span> + </span><br><span class="line">      <span class="string">"\"query\": &#123;"</span> + </span><br><span class="line">         <span class="string">"\"bool\": &#123;"</span> + </span><br><span class="line">            <span class="string">"\"must\": ["</span> + </span><br><span class="line">               <span class="string">"&#123;"</span> + </span><br><span class="line">                  <span class="string">"\"query_string\": &#123;"</span> + </span><br><span class="line">                     <span class="string">"\"default_field\": \"_all\","</span> + </span><br><span class="line">                     <span class="string">"\"query\": \""</span> + queryString + <span class="string">"\""</span> + </span><br><span class="line">                   <span class="string">"&#125;"</span> + </span><br><span class="line">               <span class="string">"&#125;"</span> + </span><br><span class="line">            <span class="string">"]"</span> + </span><br><span class="line">          <span class="string">"&#125;"</span> + </span><br><span class="line">        <span class="string">"&#125;,"</span> +</span><br><span class="line">        <span class="string">"\"size\": 0,"</span> +</span><br><span class="line">        <span class="string">"\"aggs\": &#123;"</span> + strAggs +<span class="string">"&#125;"</span>+ </span><br><span class="line">    <span class="string">"&#125;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：<br>1).使用aggs聚合函数可以根据字段去重分组，如果有多字段需要去重分组，可以嵌套使用aggs；<br>2).实际项目中，建议尽量少的使用aggs，会比较吃性能，建议将数据查询后，在后台代码中进行去重分组</p>
<h2 id="查询-Query"><a href="#查询-Query" class="headerlink" title="查询(Query)"></a>查询(Query)</h2><h3 id="1-执行查询操作，返回结果用实体类封装"><a href="#1-执行查询操作，返回结果用实体类封装" class="headerlink" title="1.执行查询操作，返回结果用实体类封装"></a>1.执行查询操作，返回结果用实体类封装</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get Documents by query DSL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dsl variable sample: &#123; "query":&#123; "query_string":&#123; "query":"field:value" &#125; &#125; &#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classOfT sample: xxxVO.class</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> List&lt;xxxVO&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getDocListByQueryDSL</span><span class="params">(String index, String type, String dsl, Class&lt;T&gt; classOfT)</span> </span>&#123;</span><br><span class="line">	String scrollId = <span class="string">""</span>;</span><br><span class="line">	List&lt;T&gt; list;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		list = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">		SearchResponse scrollResp = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type).setExtraSource(dsl).setFrom(<span class="number">0</span>)</span><br><span class="line">				.setSize(<span class="number">2000</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute().actionGet();</span><br><span class="line">		scrollId = scrollResp.getScrollId();</span><br><span class="line">		Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (SearchHit searchHit : scrollResp.getHits().getHits()) &#123;</span><br><span class="line">				list.add(gson.fromJson(searchHit.getSourceAsString(), classOfT));</span><br><span class="line">			&#125;</span><br><span class="line">			scrollResp = <span class="keyword">this</span>.esClient.prepareSearchScroll(scrollId).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute()</span><br><span class="line">					.actionGet();</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">while</span> (scrollResp.getHits().getHits().length &gt; <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-执行查询操作，返回结果用map封装"><a href="#2-执行查询操作，返回结果用map封装" class="headerlink" title="2.执行查询操作，返回结果用map封装"></a>2.执行查询操作，返回结果用map封装</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get document map by query DSL </span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dsl sample: &#123; "query":&#123; "query_string":&#123; "query":"field:value" &#125; &#125; &#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classOfT</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Map&lt;String, T&gt; Key = document ID , value = Document VO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Map&lt;String, T&gt; <span class="title">getDocMapByQueryDSL</span><span class="params">(String index, String type, String dsl, Class&lt;T&gt; classOfT)</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	String scrollId = <span class="string">""</span>;</span><br><span class="line">	</span><br><span class="line">	Map&lt;String, T&gt; retMap;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		</span><br><span class="line">		retMap = <span class="keyword">new</span> HashMap&lt;String, T&gt;();</span><br><span class="line"></span><br><span class="line">		SearchResponse scrollResp = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type).setExtraSource(dsl).setFrom(<span class="number">0</span>)</span><br><span class="line">				.setSize(<span class="number">2000</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute().actionGet();</span><br><span class="line">		scrollId = scrollResp.getScrollId();</span><br><span class="line">		</span><br><span class="line">		Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">for</span> (SearchHit searchHit : scrollResp.getHits().getHits()) &#123;</span><br><span class="line">				retMap.put(searchHit.getId(), gson.fromJson(searchHit.getSourceAsString(), classOfT));</span><br><span class="line">			&#125;</span><br><span class="line">			scrollResp = <span class="keyword">this</span>.esClient.prepareSearchScroll(scrollId).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute()</span><br><span class="line">					.actionGet();</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">while</span> (scrollResp.getHits().getHits().length &gt; <span class="number">0</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> retMap;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-根据ID查询"><a href="#3-根据ID查询" class="headerlink" title="3.根据ID查询"></a>3.根据ID查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get one document by document ID</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> docID sample: AAA_BBB_CCC</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classOfT </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> xxxVO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getDocByDocID</span><span class="params">(String index, String type, String docID, Class&lt;T&gt; classOfT)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	GetResponse response = <span class="keyword">this</span>.esClient.prepareGet(index, type, docID).get();</span><br><span class="line"></span><br><span class="line">	Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> gson.fromJson(response.getSourceAsString(), classOfT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-根据ID的List查询"><a href="#4-根据ID的List查询" class="headerlink" title="4.根据ID的List查询"></a>4.根据ID的List查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get documents by their ID</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> docIDs sample:List&lt;AAA_BBB_CCC  &gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classOfT</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getDocListByDocID</span><span class="params">(String index, String type, List&lt;String&gt; docIDs, Class&lt;T&gt; classOfT)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	String scrollId = <span class="string">""</span>;</span><br><span class="line">	List&lt;T&gt; list;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">		list = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">		SearchResponse scrollResp = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type)</span><br><span class="line">				.setQuery(QueryBuilders.idsQuery().ids(docIDs)).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).setFrom(<span class="number">0</span>)</span><br><span class="line">				.setSize(<span class="number">1000</span>).execute().actionGet();</span><br><span class="line"></span><br><span class="line">		Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (SearchHit searchHit : scrollResp.getHits().getHits()) &#123;</span><br><span class="line">				list.add(gson.fromJson(searchHit.getSourceAsString(), classOfT));</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			scrollId = scrollResp.getScrollId();</span><br><span class="line">			</span><br><span class="line">			scrollResp = <span class="keyword">this</span>.esClient.prepareSearchScroll(scrollId).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute()</span><br><span class="line">					.actionGet();</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">while</span> (scrollResp.getHits().getHits().length &gt; <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-根据ID查询字段值，返回结果用map封装"><a href="#5-根据ID查询字段值，返回结果用map封装" class="headerlink" title="5.根据ID查询字段值，返回结果用map封装"></a>5.根据ID查询字段值，返回结果用map封装</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get extra source of documents by document IDs</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fields</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &lt;p&gt;Map&lt;String, Object&gt; key = id_field, value = document id_field's value.</span></span><br><span class="line"><span class="comment"> *            sample:Map&lt;AAA_BBB_CCC_field, value&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getExtraMapByDocID</span><span class="params">(String index, String type, List&lt;String&gt; ids, String... fields)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	SearchResponse response = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type)</span><br><span class="line">			.setQuery(QueryBuilders.idsQuery().ids(ids)).setFetchSource(fields, <span class="keyword">null</span>)</span><br><span class="line">			.setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).setFrom(<span class="number">0</span>).setSize(<span class="number">1000</span>).execute().actionGet();</span><br><span class="line"></span><br><span class="line">	Map&lt;String, Object&gt; retMap = Maps.newHashMap();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (String field : fields) &#123;</span><br><span class="line"></span><br><span class="line">				String key = String.format(<span class="string">"%s_%s"</span>, hit.getId(), field);</span><br><span class="line"></span><br><span class="line">				retMap.put(key, hit.getSource().get(field));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		response = <span class="keyword">this</span>.esClient.prepareSearchScroll(response.getScrollId()).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>))</span><br><span class="line">				.execute().actionGet();</span><br><span class="line">		<span class="comment">// Break condition: No hits are returned</span></span><br><span class="line">		<span class="keyword">if</span> (response.getHits().getHits().length == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> retMap;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-根据sql查询字段值"><a href="#6-根据sql查询字段值" class="headerlink" title="6.根据sql查询字段值"></a>6.根据sql查询字段值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get Extra _source</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queryString</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fields</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> List&lt;Map&lt;String, Object&gt;&gt; Map&lt;String, Object&gt; each document key &amp;</span></span><br><span class="line"><span class="comment"> *         value List&lt;Map&lt;String, Object&gt;&gt; all document key &amp; value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; getExtraMapByQueryDSL(String index, String type, String queryDSL, String... fields)</span><br><span class="line">		<span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">	List&lt;Map&lt;String, Object&gt;&gt; rtnLst = Lists.newArrayList();</span><br><span class="line"></span><br><span class="line">	String scrollId = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">		SearchResponse response = <span class="keyword">this</span>.esClient.prepareSearch(index)</span><br><span class="line">				.setTypes(type).setExtraSource(queryDSL)</span><br><span class="line">				.setFetchSource(fields, <span class="keyword">null</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).setFrom(<span class="number">0</span>).setSize(<span class="number">1000</span>).execute()</span><br><span class="line">				.actionGet();</span><br><span class="line"></span><br><span class="line">		scrollId = response.getScrollId();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.getHitsResult(response, rtnLst, fields);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rtnLst</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fields</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Map&lt;String, Object&gt;&gt; getHitsResult(SearchResponse response, List&lt;Map&lt;String, Object&gt;&gt; rtnLst,</span><br><span class="line">		String... fields) &#123; </span><br><span class="line">	<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line">			Map&lt;String, Object&gt; tempMap = Maps.newHashMap();</span><br><span class="line">			<span class="keyword">for</span> (String field : fields) &#123;</span><br><span class="line">				tempMap.put(field, hit.getSource().get(field));</span><br><span class="line">			&#125;</span><br><span class="line">			rtnLst.add(tempMap);</span><br><span class="line">		&#125;</span><br><span class="line">		response = <span class="keyword">this</span>.esClient.prepareSearchScroll(response.getScrollId()).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>))</span><br><span class="line">				.execute().actionGet();</span><br><span class="line">		<span class="keyword">if</span> (response.getHits().getHits().length == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rtnLst;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-查询排序后的第一笔数据"><a href="#7-查询排序后的第一笔数据" class="headerlink" title="7.查询排序后的第一笔数据"></a>7.查询排序后的第一笔数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get Top 1 document by sorted DSL</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dsl</span></span><br><span class="line"><span class="comment"> *            should by with sort</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classOfT</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getTop1DocByQueryDSL</span><span class="params">(String index, String type, String dsl, Class&lt;T&gt; classOfT)</span> </span>&#123;</span><br><span class="line">	String scrollId = <span class="string">""</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		SearchResponse scrollResp = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type).setExtraSource(dsl).setFrom(<span class="number">0</span>)</span><br><span class="line">				.setSize(<span class="number">1</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute().actionGet();</span><br><span class="line">		scrollId = scrollResp.getScrollId();</span><br><span class="line">		Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">		<span class="keyword">for</span> (SearchHit searchHit : scrollResp.getHits().getHits()) &#123;</span><br><span class="line">			<span class="keyword">return</span> gson.fromJson(searchHit.getSourceAsString(), classOfT);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-通过sql查询数据是否存在"><a href="#8-通过sql查询数据是否存在" class="headerlink" title="8.通过sql查询数据是否存在"></a>8.通过sql查询数据是否存在</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check document exist or not by query DSL</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queryDsl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> esIndex</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> esType</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkDocExistByQueryDSL</span><span class="params">(String esIndex, String esType, String queryDsl)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">		SearchRequestBuilder searchBuilder = <span class="keyword">this</span>.esClient.prepareSearch(esIndex).setTypes(esType)</span><br><span class="line">				.setFetchSource(<span class="keyword">new</span> String[] &#123; <span class="string">"_id"</span> &#125;, <span class="keyword">null</span>).setExtraSource(queryDsl).setFrom(<span class="number">0</span>).setSize(<span class="number">1</span>)</span><br><span class="line">				.setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>));</span><br><span class="line"></span><br><span class="line">		SearchResponse scrollResp = searchBuilder.execute().actionGet();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (scrollResp.getHits().getTotalHits() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> e;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-查询数据笔数"><a href="#9-查询数据笔数" class="headerlink" title="9.查询数据笔数"></a>9.查询数据笔数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return total count by DSL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">getTotalHitsByDsl</span><span class="params">(String index, String type, String dsl)</span> </span>&#123;</span><br><span class="line">    String scrollId = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SearchResponse scrollResp = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type).setExtraSource(dsl).setFrom(<span class="number">0</span>)</span><br><span class="line">                .setSize(<span class="number">0</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute().actionGet();</span><br><span class="line">        scrollId = scrollResp.getScrollId();</span><br><span class="line">        <span class="keyword">return</span> scrollResp.getHits().getTotalHits();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="新增-Upsert"><a href="#新增-Upsert" class="headerlink" title="新增(Upsert)"></a>新增(Upsert)</h2><p>注：upsert用法：有记录就更新，没有记录就新增</p>
<h3 id="1-通过ID-执行upsert操作"><a href="#1-通过ID-执行upsert操作" class="headerlink" title="1.通过ID 执行upsert操作"></a>1.通过ID 执行upsert操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Upsert data by VO + document ID.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> vo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">IndexResponse <span class="title">upsert</span><span class="params">(String index, String type, String docID, T vo)</span> </span>&#123;</span><br><span class="line">	Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">	String source = gson.toJson(vo);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.esClient.prepareIndex(index, type, docID).setRefresh(<span class="keyword">true</span>).setSource(source).execute().actionGet();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-批量upsert"><a href="#2-批量upsert" class="headerlink" title="2.批量upsert"></a>2.批量upsert</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> voList</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> getDocIDMethodInVo</span></span><br><span class="line"><span class="comment">   *                sample : public String getDocumentID() &#123; return</span></span><br><span class="line"><span class="comment">   *               String.format("%s_%s", AAA,BBB); &#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> isAutoRefresh</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">bulkProcessUpsert</span><span class="params">(String index, String type, List&lt;T&gt; voList, String getDocIDMethodInVo, <span class="keyword">boolean</span> isAutoRefresh)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">      </span><br><span class="line">      BulkRequestBuilder bulkRequest = <span class="keyword">this</span>.esClient.prepareBulk();</span><br><span class="line">      bulkRequest.setTimeout(TimeValue.timeValueMinutes(<span class="number">20</span>));</span><br><span class="line">      </span><br><span class="line">  	<span class="keyword">for</span> (T vo : voList) &#123;</span><br><span class="line"></span><br><span class="line">	Method addMethod = vo.getClass().getMethod(getDocIDMethodInVo, <span class="keyword">new</span> Class[] &#123;&#125;);</span><br><span class="line"></span><br><span class="line">	Object result = addMethod.invoke(vo, <span class="keyword">new</span> Object[] &#123;&#125;);</span><br><span class="line"></span><br><span class="line">	 IndexRequestBuilder indexRequestBuilder = <span class="keyword">this</span>.esClient.prepareIndex(index, type, result.toString()).setSource(gson.toJson(vo));</span><br><span class="line">        bulkRequest.add(indexRequestBuilder);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span> (bulkRequest.numberOfActions() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          BulkResponse resp = bulkRequest.setRefresh(isAutoRefresh).execute().actionGet();</span><br><span class="line">          <span class="keyword">if</span> (resp.hasFailures()) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> Exception(String.format(<span class="string">"Bulk index items failed, message:%s"</span>, resp.buildFailureMessage()));</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="更新-Update"><a href="#更新-Update" class="headerlink" title="更新(Update)"></a>更新(Update)</h2><h3 id="1-根据ID执行update操作"><a href="#1-根据ID执行update操作" class="headerlink" title="1.根据ID执行update操作"></a>1.根据ID执行update操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * update Extra fields by document ID</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fieldValMap:key=index field, value = value to be update</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UpdateResponse <span class="title">update</span><span class="params">(String index, String type, String id, Map&lt;String, Object&gt; fieldValMap)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.esClient.update(<span class="keyword">new</span> UpdateRequest(index, type, id).refresh(<span class="keyword">true</span>).doc(fieldValMap)).get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-批量update"><a href="#2-批量update" class="headerlink" title="2.批量update"></a>2.批量update</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Update datas. Map key is doc_id, Map Value is update field-value map.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">bulkProcessUpdate</span><span class="params">(String index, String type, Map&lt;String, Map&lt;String, Object&gt;&gt; mapUpdates, <span class="keyword">boolean</span> isAutoRefresh)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    BulkRequestBuilder bulkRequest = <span class="keyword">this</span>.esClient.prepareBulk();</span><br><span class="line">    bulkRequest.setTimeout(TimeValue.timeValueMinutes(<span class="number">20</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String docId : mapUpdates.keySet()) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; mapUpdateFieldValue = mapUpdates.get(docId);</span><br><span class="line">        XContentBuilder jsonBuilder = XContentFactory.jsonBuilder().startObject();</span><br><span class="line">        <span class="keyword">for</span> (String key : mapUpdateFieldValue.keySet()) &#123;</span><br><span class="line">            jsonBuilder.field(key, mapUpdateFieldValue.get(key));</span><br><span class="line">        &#125;</span><br><span class="line">        jsonBuilder.endObject();</span><br><span class="line">        UpdateRequestBuilder updateRequestBuilder = <span class="keyword">this</span>.esClient.prepareUpdate(index, type, docId)</span><br><span class="line">                .setDoc(jsonBuilder);</span><br><span class="line">        bulkRequest.add(updateRequestBuilder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bulkRequest.numberOfActions() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        BulkResponse resp = bulkRequest.setRefresh(isAutoRefresh).execute().actionGet();</span><br><span class="line">        <span class="keyword">if</span> (resp.hasFailures()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(String.format(<span class="string">"Bulk update items failed, message:%s"</span>, resp.buildFailureMessage()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="删除-Delete"><a href="#删除-Delete" class="headerlink" title="删除(Delete)"></a>删除(Delete)</h2><h3 id="1-根据ID-删除"><a href="#1-根据ID-删除" class="headerlink" title="1.根据ID 删除"></a>1.根据ID 删除</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Delete data by id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteById</span><span class="params">(String index, String type, String id)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.esClient.prepareDelete(index, type, id).setRefresh(<span class="keyword">true</span>).execute().actionGet().isFound();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-批量删除"><a href="#2-批量删除" class="headerlink" title="2.批量删除"></a>2.批量删除</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bulk delete by document IDs</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> lstId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bulkProcessDelete</span><span class="params">(String index, String type, List&lt;String&gt; lstId)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> BulkProcessor bulkProcessor = BulkProcessor.builder(<span class="keyword">this</span>.esClient, <span class="keyword">new</span> BulkProcessor.Listener() &#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeBulk</span><span class="params">(<span class="keyword">long</span> executionId, BulkRequest request)</span> </span>&#123;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterBulk</span><span class="params">(<span class="keyword">long</span> executionId, BulkRequest request, BulkResponse response)</span> </span>&#123;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterBulk</span><span class="params">(<span class="keyword">long</span> executionId, BulkRequest request, Throwable failure)</span> </span>&#123;</span><br><span class="line">			failure.printStackTrace();</span><br><span class="line">			logger.error(<span class="string">"ElasticsearchHelper.bulkProcessDelete.Index is &#123;&#125;. error is &#123;&#125;. "</span>, index,</span><br><span class="line">					failure.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;).setBulkActions(BULK_MAX_SIZE).setBulkSize(<span class="keyword">new</span> ByteSizeValue(<span class="number">1</span>, ByteSizeUnit.GB))</span><br><span class="line">			.setFlushInterval(TimeValue.timeValueSeconds(<span class="number">5</span>)).build();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (String docId : lstId) &#123;</span><br><span class="line">			bulkProcessor.add(<span class="keyword">new</span> DeleteRequest(index, type, docId));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		logger.error(<span class="string">"ElasticsearchHelper.bulkProcessUpdateItems.Index is &#123;&#125;. error is &#123;&#125;. "</span>, ex);</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		bulkProcessor.awaitClose(<span class="number">1</span>, TimeUnit.MINUTES);</span><br><span class="line">		<span class="keyword">this</span>.esClient.admin().indices().prepareRefresh(index).get();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-根据DSL删除"><a href="#3-根据DSL删除" class="headerlink" title="3.根据DSL删除"></a>3.根据DSL删除</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Delete by query</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queryDsl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteByQueryDsl</span><span class="params">(String queryDsl , String index, String type, <span class="keyword">boolean</span> isAutoRefresh)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	</span><br><span class="line">	Client client = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		</span><br><span class="line">		client =<span class="keyword">this</span>.esClient;</span><br><span class="line"></span><br><span class="line">		SearchRequestBuilder searchBuilder = client.prepareSearch(index)</span><br><span class="line">					.setTypes(type)</span><br><span class="line">					.setExtraSource(queryDsl).setFrom(<span class="number">0</span>).setSize(<span class="number">1500</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>));</span><br><span class="line"></span><br><span class="line">		SearchResponse scrollResp = searchBuilder.execute().actionGet();</span><br><span class="line">	 </span><br><span class="line">		BulkRequestBuilder bulkRequest = client.prepareBulk();</span><br><span class="line">		bulkRequest.setTimeout(TimeValue.timeValueMinutes(<span class="number">20</span>));</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (SearchHit hit : scrollResp.getHits().getHits()) &#123;</span><br><span class="line">					bulkRequest.add(client.prepareDelete(index, type, hit.getId()));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			scrollResp = client.prepareSearchScroll(scrollResp.getScrollId()).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute().actionGet();</span><br><span class="line">				</span><br><span class="line">			<span class="comment">// Break condition: No hits are returned</span></span><br><span class="line">			<span class="keyword">if</span> (scrollResp.getHits().getHits().length == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (bulkRequest.numberOfActions() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			BulkResponse response = bulkRequest.setRefresh(isAutoRefresh).execute().actionGet();</span><br><span class="line">			<span class="keyword">if</span> (response.hasFailures()) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> Exception(</span><br><span class="line">						<span class="string">"deleteByFilter failure:"</span> + response.buildFailureMessage());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * delete documents By Query DSL</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dsl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteByQueryDsl</span><span class="params">(String index, String type, String dsl)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	String scrollId = <span class="string">""</span>;</span><br><span class="line">	List&lt;String&gt; lstId;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">		lstId = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">		SearchResponse scrollResp = <span class="keyword">this</span>.esClient.prepareSearch(index).setTypes(type).setExtraSource(dsl).setFrom(<span class="number">0</span>)</span><br><span class="line">				.setSize(<span class="number">2000</span>).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute().actionGet();</span><br><span class="line">		scrollId = scrollResp.getScrollId();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (SearchHit searchHit : scrollResp.getHits().getHits()) &#123;</span><br><span class="line">				lstId.add(searchHit.getId());</span><br><span class="line">			&#125;</span><br><span class="line">			scrollResp = <span class="keyword">this</span>.esClient.prepareSearchScroll(scrollId).setScroll(<span class="keyword">new</span> TimeValue(<span class="number">60000</span>)).execute()</span><br><span class="line">					.actionGet();</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">while</span> (scrollResp.getHits().getHits().length &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.bulkProcessDelete(index, type, lstId);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.clearESScrollId(scrollId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>我们在执行ES操作的时候，为了避免一次操作的数据量过大，通常会设置size；因此，我们用到了scrollId；在方法finally中，需要将scrollId清除。<br>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearESScrollId</span><span class="params">(String scrollId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isNoneEmpty(scrollId)) &#123;</span><br><span class="line">			ClearScrollRequest clearScrollerRequest = <span class="keyword">new</span> ClearScrollRequest();</span><br><span class="line">			clearScrollerRequest.addScrollId(scrollId);</span><br><span class="line">			<span class="keyword">this</span>.esClient.clearScroll(clearScrollerRequest).actionGet();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/30/ElasticSearch%E5%B8%B8%E7%94%A8%E7%9A%84%E5%A2%9E%E5%88%A0%E6%9F%A5%E6%94%B9%E6%93%8D%E4%BD%9C/" data-id="ck6ge63zv0007ecv1bli767ha" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Windows系统向ElasticSearch bulk批量同步数据" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/30/Windows%E7%B3%BB%E7%BB%9F%E5%90%91ElasticSearch%20bulk%E6%89%B9%E9%87%8F%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE/" class="article-date">
  <time datetime="2019-12-30T12:28:10.067Z" itemprop="datePublished">2019-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/30/Windows%E7%B3%BB%E7%BB%9F%E5%90%91ElasticSearch%20bulk%E6%89%B9%E9%87%8F%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE/">Windows系统向ElasticSearch bulk批量同步数据</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Windows系统向ElasticSearch-bulk批量同步数据"><a href="#Windows系统向ElasticSearch-bulk批量同步数据" class="headerlink" title="Windows系统向ElasticSearch bulk批量同步数据"></a>Windows系统向ElasticSearch bulk批量同步数据</h1><p>我们知道，通过API可以实现对ElasticSearch批量增删查改操作。但是，常用的head或kopf插件对于批处理操作则显得心有余而力不足。本文将详细介绍一种不依赖于API的批量处理方式。</p>
<h2 id="1-整体思路"><a href="#1-整体思路" class="headerlink" title="1.整体思路"></a>1.整体思路</h2><ul>
<li>保存需要批量处理的数据到json文件</li>
<li>通过crud命令向ES服务器发送_bulk请求</li>
</ul>
<p>#保存需要批量操作的数据到json文件<br><img src="https://upload-images.jianshu.io/upload_images/15990705-a54da01afa7cd929.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>文件格式如下：<br>{“index”:{“_index”: “test_damon_v1”, “_type”: “test_damon”, “_id”:”4”}}<br>{“plant”: “F131”,”stb_version”: “4444444444”}<br>两行数据构成了一次操作，第一行是操作类型可以index，create，update；第二行就是我们的可选的数据体。<br>如果是delete操作，只有一行数据，因为只需要提供一个id即可。<br>注意：</p>
<ul>
<li>每一行数据结束，必须换行，否则对应数据会执行失败</li>
<li>官方建议 bulk 批次最好不要超过15MB</li>
</ul>
<h2 id="2-Windows系统安装curl"><a href="#2-Windows系统安装curl" class="headerlink" title="2.Windows系统安装curl"></a>2.Windows系统安装curl</h2><ul>
<li>curl下载地址：<a href="https://curl.haxx.se/download.html" target="_blank" rel="noopener"><u>https://curl.haxx.se/download.html</u></a><br>建议下载如图所示版本：<br><img src="https://upload-images.jianshu.io/upload_images/15990705-361c8eb93badf07d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>下载完成以后是一个后缀名为.cab的文件；然后解压缩。<br><img src="https://upload-images.jianshu.io/upload_images/15990705-c9c324acfd25dc1e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></li>
<li>配置环境变量<br><img src="https://upload-images.jianshu.io/upload_images/15990705-0ee0673429699934.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br><img src="https://upload-images.jianshu.io/upload_images/15990705-8b3c2f4b1fa7c970.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></li>
<li>检测是否安装成功<br>在cmd界面输入命令curl –help，显示如下图，则表示安装成功。<br><img src="https://upload-images.jianshu.io/upload_images/15990705-bf8ace7f6e6e7086.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></li>
</ul>
<h2 id="3-使用curl向ES服务器发送请求"><a href="#3-使用curl向ES服务器发送请求" class="headerlink" title="3.使用curl向ES服务器发送请求"></a>3.使用curl向ES服务器发送请求</h2><ul>
<li>cmd进入curl\I386路径以后执行以下命令，@后面是你的json文件所在的位置。<br>curl -l -H “Content-Type:application/json” -H “Accept:application/json” -XPOST localhost:9200/_bulk?pretty –data-binary  @C:\Users\Desktop\test.json<br>如下图所示：<br><img src="https://upload-images.jianshu.io/upload_images/15990705-7ae9d3234ffef3d0.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>若出现以下结果，则表示处理成功：<br><img src="https://upload-images.jianshu.io/upload_images/15990705-163bc7f95fcbaedd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></li>
<li>验证数据是否同步成功<br>进入ES的head插件，我们批量处理，插入的数据是id为4和5的数据。<br>查询结果如下：<br><img src="https://upload-images.jianshu.io/upload_images/15990705-be1bbba1ddc8bfe9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/30/Windows%E7%B3%BB%E7%BB%9F%E5%90%91ElasticSearch%20bulk%E6%89%B9%E9%87%8F%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE/" data-id="ck6ge63zd0005ecv1d8td8wtq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Docker简介及环境搭建" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/18/Docker%E7%AE%80%E4%BB%8B%E5%8F%8A%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="article-date">
  <time datetime="2019-12-18T14:49:05.675Z" itemprop="datePublished">2019-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/18/Docker%E7%AE%80%E4%BB%8B%E5%8F%8A%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">Docker简介及环境搭建</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Docker-简介及环境搭建"><a href="#Docker-简介及环境搭建" class="headerlink" title="Docker 简介及环境搭建"></a>Docker 简介及环境搭建</h1><h2 id="1-Docker是什么"><a href="#1-Docker是什么" class="headerlink" title="1.Docker是什么"></a>1.Docker是什么</h2><p>Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的镜像中，然后发布到任何流行的 Linux或Windows 机器上，也可以实现虚拟化。容器是完全使用沙箱机制，相互之间不会有任何接口。</p>
<h2 id="2-Docker相关概念"><a href="#2-Docker相关概念" class="headerlink" title="2.Docker相关概念"></a>2.Docker相关概念</h2><ul>
<li>Doker Host 主机<ul>
<li>安装了Docker程序的机器，Docker直接安装在操作系统之上</li>
</ul>
</li>
<li>Dcoker Client 客户端<ul>
<li>通过命令行或其他工具使用Docker</li>
</ul>
</li>
<li>Docker Images 镜像<ul>
<li>软件打包好的镜像，用于创建Docker容器的模板</li>
</ul>
</li>
<li>Dcoker Container 容器<ul>
<li>镜像启动后的实例称为一个容器，容器是独立运行的一个或一组应用</li>
</ul>
</li>
<li>Docker Registry 仓库<ul>
<li>保存各种打包好的Docker镜像</li>
</ul>
</li>
</ul>
<h2 id="3-使用Docker的步骤"><a href="#3-使用Docker的步骤" class="headerlink" title="3.使用Docker的步骤"></a>3.使用Docker的步骤</h2><ul>
<li>安装Docker</li>
<li>去Docker仓库找到软件对应镜像</li>
<li>使用Docker运行镜像，生成Docker容器</li>
<li>对容器的启停就是对软件的启停</li>
</ul>
<h2 id="4-安装Docker"><a href="#4-安装Docker" class="headerlink" title="4.安装Docker"></a>4.安装Docker</h2><h3 id="1-安装Linux虚拟机"><a href="#1-安装Linux虚拟机" class="headerlink" title="1).安装Linux虚拟机"></a>1).安装Linux虚拟机</h3><ul>
<li><p>安装Virtual Box</p>
</li>
<li><p>导入CentOS7</p>
</li>
<li><p>启动虚拟机</p>
</li>
<li><p>设置虚拟机网络，如果是连接的WiFi，需要选择无线网卡</p>
</li>
<li><p>使用命令重启虚拟机网络  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service network restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看LinuxIP地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用客户端工具连接虚拟机</p>
</li>
</ul>
<h3 id="2-在Linux虚拟机安装Docker"><a href="#2-在Linux虚拟机安装Docker" class="headerlink" title="2). 在Linux虚拟机安装Docker"></a>2). 在Linux虚拟机安装Docker</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.检查内核版本，必须是3.10以上</span><br><span class="line">	uname -r</span><br><span class="line">2.安装Docker</span><br><span class="line">	yum install docker</span><br><span class="line">3.输入y确认安装</span><br><span class="line">4.启动Docker</span><br><span class="line">	systemctl start docker</span><br><span class="line">5.查看Docker版本</span><br><span class="line">	docker -v</span><br><span class="line">6.开机启动Docker</span><br><span class="line">	systemctl enable docker</span><br><span class="line">7.停止Docker</span><br><span class="line">	systemctl stop docker</span><br></pre></td></tr></table></figure>

<h2 id="5-踩过的坑"><a href="#5-踩过的坑" class="headerlink" title="5.踩过的坑"></a>5.踩过的坑</h2><h3 id="1-安装docker不报错，但是启动的时候以下错误："><a href="#1-安装docker不报错，但是启动的时候以下错误：" class="headerlink" title="1).安装docker不报错，但是启动的时候以下错误："></a>1).安装docker不报错，但是启动的时候以下错误：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Job for docker.service failed because the control process exited with error code. See "systemctl status docker.service" and "journalctl -xe" for details.</span><br></pre></td></tr></table></figure>

<p>原因：可能还是因为内核版本问题</p>
<p>解决方案：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1.卸载之前安装的docker</span><br><span class="line">	yum remove docker-*</span><br><span class="line">2.更新Linux内核</span><br><span class="line">	yum update</span><br><span class="line">3.重新安装docker</span><br><span class="line">	yum install docker</span><br><span class="line">4.重启虚拟机</span><br><span class="line">5.启动docker</span><br><span class="line">	systemctl start docker</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/18/Docker%E7%AE%80%E4%BB%8B%E5%8F%8A%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" data-id="ck6ge63zc0004ecv14r2hh19f" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/02/10/SpringCloud%20Eureka/">SpringCloud Eureka</a>
          </li>
        
          <li>
            <a href="/2020/02/10/SpringCloud%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%B7%A5%E7%A8%8B%E6%9E%84%E5%BB%BA/">SpringCloud微服务工程构建</a>
          </li>
        
          <li>
            <a href="/2020/02/10/SpringCloud%E6%A6%82%E8%BF%B0/">SpringCloud概述</a>
          </li>
        
          <li>
            <a href="/2020/02/06/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0/">微服务概述</a>
          </li>
        
          <li>
            <a href="/2020/01/06/Docker%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/">Docker常用操作</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Damon Liu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>